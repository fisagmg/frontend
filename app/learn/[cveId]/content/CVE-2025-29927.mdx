# 취약점 개요

## 📋 설명

Next.js는 서버 사이드 렌더링(SSR)과 정적 웹 페이지 생성(SSG)을 지원하는 Node.js 기반의 오픈소스 웹 프레임워크입니다. React 공식 문서에서 권장하는 툴체인 중 하나로, 2025년 4월 기준 전 세계 442만 개 사이트에서 사용되고 있습니다.

CVE-2025-29927은 Next.js의 **middleware 우회 취약점**입니다. 특정 헤더 값(`x-middleware-subrequest`)을 조작하여 middleware가 이미 실행되었는지 확인하는 내부 로직을 악용할 수 있습니다.

공격자는 이 취약점을 통해 **인증 절차를 우회**하고 제한된 페이지(예: 관리자 페이지)에 무단 접근할 수 있습니다.

## ⚠️ 왜 위험한가?

**광범위한 영향**: 전 세계 442만 개 이상의 Next.js 사이트가 잠재적 위험에 노출

**인증 무력화**: Middleware를 통한 인증 구현이 완전히 우회 가능

**낮은 공격 난이도**: 단순 HTTP 헤더 조작만으로 관리자 페이지 접근

**민감 정보 노출**: 사용자 관리 페이지, 개인정보, 내부 시스템 접근 가능

---

# 공격 시나리오

**Initial Access:** 공격자가 취약한 Next.js 버전을 사용하는 서버 탐색

**Privilege Escalation:** `x-middleware-subrequest` 헤더 조작으로 middleware 인증 우회

**Defense Evasion:** 서버는 이미 인증이 완료된 것으로 오인

**Impact:** 관리자 페이지 접근 → 대량의 개인정보 열람 및 탈취 → 외부 유출

---

# 실습 환경 구성

| 역할        | 구성                     | IP              |
| ----------- | ------------------------ | --------------- |
| 피해자 서버 | Next.js v15.1.7 (Docker) | 192.168.0.3     |
| 공격자      | Kali Linux               | 192.168.216.133 |

## 사전 준비사항

- Docker 설치
- Node.js 환경
- 기본적인 HTTP 요청 지식
- Burp Suite 또는 curl 사용 능력

---

# 패치 정보

## 안전한 버전

- **Next.js v15.2.3 이상**
- **Next.js v14.2.25 이상**
- **Next.js v13.5.9 이상**
- **Next.js v12.3.5 이상**

⚠️ **Next.js v11.x**는 지원 종료로 패치 불가 → v15로 마이그레이션 권장

## 보안 조치

패치 버전에서는 `crypto.getRandomValues`로 생성한 **8바이트 난수**를 `x-middleware-subrequest-id` 헤더로 검증

공격자가 예측 불가능한 값이므로 middleware 우회 차단

## 임시 대응 방안

업그레이드가 어려운 경우:

- WAF/리버스 프록시에서 `x-middleware-subrequest` 헤더 포함 요청 차단
- Middleware 대신 서버 사이드 인증 구현 검토

---

# 참고 자료

[GitHub Security Advisory](https://github.com/vercel/next.js/security/advisories/GHSA-f82v-jwr5-mffw)

[Next.js 공식 문서 - Middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware)

[취약점 발견자 연구 보고서](https://zhero-web-sec.github.io/research-and-things/nextjs-and-the-corrupt-middleware)

[CVE 상세정보](https://nvd.nist.gov/vuln/detail/CVE-2025-29927)
