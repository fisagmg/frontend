# 취약점 개요

## 📋 설명

Apache Struts2는 Java EE 웹 애플리케이션 개발을 위한 오픈소스 프레임워크로, 전 세계적으로 널리 사용되고 있습니다. 2025년 1월 기준 약 358만 개 사이트에서 활용 중입니다.

CVE-2024-53677은 **Apache Struts2의 File Upload Interceptor에서 발생하는 파일 업로드 우회 취약점**입니다. 이 취약점은 CVE-2023-50164의 불완전한 패치로 인해 발생했으며, **OGNL(Object-Graph Navigation Language) 표현식**을 악용하여 파일명을 재정의할 수 있습니다.

공격자는 `top.uploadFileName`과 같은 OGNL 표현식을 사용하여 ValueStack의 파라미터 바인딩 로직을 우회하고, **임의 경로에 악성 JSP 웹쉘을 업로드**할 수 있습니다.

## ⚠️ 왜 위험한가?

**광범위한 영향**: 전 세계 358만 개 사이트가 잠재적 위험에 노출

**활발한 악용**: 2024년 12월 17일부터 실제 공격 시도 다수 보고

**낮은 공격 복잡도**: 파일 업로드 기능만 있으면 공격 가능

**완전한 시스템 장악**: 웹쉘을 통한 원격 명령 실행 및 데이터 탈취

**국가 기관 경보**: 캐나다, 호주, 벨기에 등 다수 국가에서 긴급 패치 권고

---

# 공격 시나리오

**Initial Access:** 공격자가 Apache Struts2를 사용하는 파일 업로드 페이지 발견

**Exploitation:** OGNL 표현식(`top.uploadFileName`)을 이용하여 파일명 재정의

**Execution:** 임의 경로(`../`)에 악성 JSP 웹쉘 업로드 성공

**Persistence:** 웹쉘을 통해 서버에서 임의 명령 실행

**Impact:** 데이터베이스 정보 탈취, 랜섬웨어 설치, 또는 추가 공격을 위한 거점 확보

---

# 실습 환경 구성

| 역할        | 구성                            | IP              |
| ----------- | ------------------------------- | --------------- |
| 피해자 서버 | Apache Struts2 6.3.0.2 (Docker) | 192.168.0.5     |
| 공격자      | Kali Linux                      | 192.168.216.129 |

## 사전 준비사항

- Docker 환경
- Python 3.x
- 기본적인 HTTP 요청 지식 (Burp Suite 또는 curl)
- OGNL 표현식 이해

---

# 패치 정보

## 안전한 버전

- **Apache Struts2 6.4.0 이상** (권장)
- **Apache Struts2 7.0.0 이상** (File Upload Interceptor 완전 제거)

## 패치 방법

**1. Struts2 버전 업그레이드:**

Maven 프로젝트의 경우 `pom.xml` 수정:

```xml
<dependency>
    <groupId>org.apache.struts</groupId>
    <artifactId>struts2-core</artifactId>
    <version>6.4.0</version>
</dependency>
```

**2. Interceptor 변경:**

`struts.xml`에서 File Upload Interceptor를 Action File Upload Interceptor로 교체:

```xml
<!-- ❌ 취약한 설정 -->
<interceptor-ref name="fileUpload"/>

<!-- ✅ 안전한 설정 -->
<interceptor-ref name="actionFileUpload"/>
```

## 임시 대응 방안

업그레이드가 어려운 경우:

- 파일 업로드 기능 임시 비활성화
- WAF에서 `top.`, `[0].` 등의 패턴 차단
- 업로드 디렉토리에 실행 권한 제거
- 화이트리스트 기반 파일 확장자 검증

---

# 참고 자료

[Apache Struts S2-067 공지](https://cwiki.apache.org/confluence/display/WW/S2-067)

[File Upload Interceptor 문서](https://struts.apache.org/core-developers/file-upload-interceptor)

[Action File Upload 문서](https://struts.apache.org/core-developers/action-file-upload)

[EQST Lab PoC](https://github.com/EQSTLab/CVE-2024-53677)

[AttackerKB 분석](https://attackerkb.com/topics/YfjepZ70DS/cve-2024-53677)
