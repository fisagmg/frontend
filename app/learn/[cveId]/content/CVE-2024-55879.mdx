# 취약점 개요

## 📋 설명

XWiki는 Java로 개발된 무료 오픈소스 위키 소프트웨어로, 많은 사용자가 웹 페이지를 만들고 편집할 수 있도록 지원합니다. 2025년 2월 기준 전 세계 약 4만 개 사이트에서 사용되고 있습니다.

CVE-2024-55879는 XWiki의 **Administration Application의 ConfigurableClass 기능**에서 발생하는 원격 코드 실행 취약점입니다. 공격자는 Script 권한이 있는 계정을 이용하여 사용자 객체에 ConfigurableClass를 추가하고, **heading 속성에 악성 Velocity/Groovy 스크립트를 주입**할 수 있습니다.

이 취약점은 **SSTI(Server-Side Template Injection)**의 전형적인 사례로, Velocity 템플릿 엔진이 사용자 입력을 평가하는 과정에서 `codeToExecuteResult` 변수를 통해 Groovy 스크립트가 실행되어 발생합니다.

## ⚠️ 왜 위험한가?

**광범위한 영향**: 전 세계 약 4만 개 사이트가 잠재적 위험에 노출

**낮은 공격 복잡도**: Script 권한만 있으면 웹 UI를 통해 공격 가능

**완전한 서버 제어**: 리버스 쉘 획득을 통한 시스템 장악 가능

**탐지 어려움**: 정상적인 관리 기능(사용자 정보 수정)으로 위장 가능

**데이터 유출**: 위키 내 모든 문서, 사용자 정보, 첨부 파일 접근 가능

---

# 공격 시나리오

**Initial Access:** 공격자가 XWiki 사용자 계정 탈취 (피싱, 자격 증명 유출 등)

**Privilege Escalation:** Script 권한이 있는 관리자 계정으로 권한 상승

**Execution:** 사용자 객체에 ConfigurableClass 추가 후 heading 속성에 악성 Groovy 스크립트 주입

**Persistence:** 리버스 쉘을 통해 서버 제어권 확보

**Impact:** 암호화폐 채굴기 설치 또는 랜섬웨어 배포, 민감한 위키 데이터 탈취

---

# 실습 환경 구성

| 역할        | 구성                             | IP         |
| ----------- | -------------------------------- | ---------- |
| 피해자 서버 | XWiki-platform v15.10.5 (Docker) | 172.19.0.4 |
| 공격자      | Kali Linux                       | 172.19.0.3 |

## 사전 준비사항

- Docker & Docker Compose
- Script 권한이 있는 XWiki 계정
- 기본적인 Velocity 및 Groovy 지식
- Netcat (리버스 쉘 수신)

---

# 패치 정보

## 안전한 버전

- **XWiki v15.10.9 이상**
- **XWiki v16.3.0 이상**

## 패치 내용

패치에서는 `codeToExecuteResult` 변수의 실행 로직을 제거하고, 단순 문자열로 출력하도록 변경하여 코드 실행을 방지했습니다.

**변경 전 (취약):**

```velocity
$codeToExecuteResult
```

**변경 후 (안전):**

```velocity
{{html}}$services.rendering.escape($codeToExecuteResult, 'xwiki/2.1'){{/html}}
```

## 업그레이드 방법

| 배포 환경             | 패치 방법                                                       |
| --------------------- | --------------------------------------------------------------- |
| **패키지 업그레이드** | `sudo apt install xwiki-tomcat9-mariadb`                        |
| **Docker 업그레이드** | 공식 문서 참조하여 이미지 변경                                  |
| **WAR 업그레이드**    | 기존 WAR 삭제 후 새 버전 다운로드 또는 Distribution Wizard 사용 |
| **데모 패키지**       | 새 버전 별도 설치 후 설정 파일 수동 편집                        |

⚠️ **패치 전 반드시 백업하세요!**

---

# 참고 자료

[GitHub Security Advisory](https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-r279-47wg-chpr)

[패치 커밋](https://github.com/xwiki/xwiki-platform/commit/8493435ff9606905a2d913607d6c79862d0c168d)

[XWiki 업그레이드 가이드](https://www.xwiki.org/xwiki/bin/view/Documentation/AdminGuide/Upgrade)

[Jira 이슈](https://jira.xwiki.org/browse/XWIKI-21207)
