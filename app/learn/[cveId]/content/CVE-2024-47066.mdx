# ì·¨ì•½ì  ê°œìš”

## ğŸ“‹ ì„¤ëª…

Lobe Chatì€ **ì‚¬ìš©ì í”ŒëŸ¬ê·¸ì¸ì„ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ ì™¸ë¶€ URLì„ í”„ë¡ì‹œë¡œ ìš”ì²­í•˜ëŠ” ê¸°ëŠ¥**ì„ ì œê³µí•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ `/api/proxy` ì—”ë“œí¬ì¸íŠ¸ì—ì„œ **ë‚´ë¶€ë§ ì£¼ì†Œ í•„í„°ë§ì´ IP ê¸°ë°˜ ì •ê·œì‹ì—ë§Œ ì˜ì¡´**í•´, ë¦¬ë‹¤ì´ë ‰ì…˜ ê¸°ë°˜ SSRF ìš°íšŒê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ë‚´ë¶€ë§ IP(`192.168.*`, `10.*`, `172.16â€“31.*`)ëŠ” ì°¨ë‹¨ë˜ì§€ë§Œ, **ì™¸ë¶€ ì£¼ì†Œ â†’ ë‚´ë¶€ ì£¼ì†Œë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜**ë˜ëŠ” ê²½ìš° `fetch()`ì˜ **redirect: follow ê¸°ë³¸ ì„¤ì •**ì— ì˜í•´ ë‚´ë¶€ë§ìœ¼ë¡œ ìš”ì²­ì´ ì „ì†¡ë©ë‹ˆë‹¤.

ì¦‰, ë‚´ë¶€ë§ ì ‘ê·¼ì´ ê°€ëŠ¥í•´ì ¸ **OllamaÂ·AWS Metadata ë“± ë¯¼ê° ì„œë¹„ìŠ¤ íƒˆì·¨ ê°€ëŠ¥**í•©ë‹ˆë‹¤.

## âš ï¸ ì™œ ìœ„í—˜í•œê°€?

**ë‚®ì€ ê³µê²© ë‚œì´ë„**: ì™¸ë¶€ ì£¼ì†Œë¥¼ í†µí•œ ë¦¬ë‹¤ì´ë ‰ì…˜ìœ¼ë¡œ ë‚´ë¶€ë§ ì ‘ê·¼ ê°€ëŠ¥

**ê´‘ë²”ìœ„í•œ ì˜í–¥**: ì „ ì„¸ê³„ ì•½ 7ì²œì—¬ ê°œ Lobe Chat ì¸ìŠ¤í„´ìŠ¤ê°€ ì ì¬ì  ìœ„í—˜ì— ë…¸ì¶œ

**ì¹˜ëª…ì ì¸ ì—°ê³„ ê³µê²©**: SSRF â†’ ë‚´ë¶€ë§ ìŠ¤ìº” â†’ AWS Metadata ì ‘ê·¼ â†’ IAM Credential íƒˆì·¨ â†’ EC2 ê¶Œí•œ íšë“

**Cloud í™˜ê²½ì—ì„œì˜ ì‹¬ê°ì„±**: AWS Metadata â†’ IAM Role íƒˆì·¨ â†’ RCEë¡œ ì´ì–´ì§

**ë‚´ë¶€ ì„œë¹„ìŠ¤ ì •ë³´ ìˆ˜ì§‘**: Ollama ë“± ë‚´ë¶€ LLM ì„œë¹„ìŠ¤ ì •ë³´ íƒˆì·¨ ê°€ëŠ¥

---

## ì·¨ì•½ì  ì •ë³´

| í•­ëª©           | ë‚´ìš©                                                      |
| -------------- | --------------------------------------------------------- |
| CVSS ì ìˆ˜      | 8.2 (High)                                                |
| ì·¨ì•½ì  ìœ í˜•    | SSRF(Server-Side Request Forgery)                         |
| ê³µê²© íë¦„      | SSRF â†’ ë‚´ë¶€ë§ ìŠ¤ìº” â†’ AWS Metadata ì ‘ê·¼ â†’ IAM Credential íƒˆì·¨ â†’ EC2 ê¶Œí•œ íšë“ |
| ì˜í–¥ ë²„ì „      | Lobe Chat 1.19.12 ì´í•˜                                    |
| ê³µê°œì¼         | 2024ë…„ 9ì›” 23ì¼                                           |
| ì˜í–¥ ë²”ìœ„       | ì „ ì„¸ê³„ ì•½ 7ì²œì—¬ ê°œ Lobe Chat ì¸ìŠ¤í„´ìŠ¤(2024ë…„ 10ì›” ê¸°ì¤€)   |

## ğŸ§  í•µì‹¬ ì›ì¸: `/api/proxy` ë‚´ë¶€ë§ ì°¨ë‹¨ ë¡œì§ ìš°íšŒ

ë‚´ë¶€ë§ IP(`192.168.*`, `10.*`, `172.16â€“31.*`)ëŠ” ì°¨ë‹¨ë˜ì§€ë§Œ, **ì™¸ë¶€ ì£¼ì†Œ â†’ ë‚´ë¶€ ì£¼ì†Œë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜**ë˜ëŠ” ê²½ìš° `fetch()`ì˜ **redirect: follow ê¸°ë³¸ ì„¤ì •**ì— ì˜í•´ ë‚´ë¶€ë§ìœ¼ë¡œ ìš”ì²­ì´ ì „ì†¡ë©ë‹ˆë‹¤.

### ì·¨ì•½í•œ ì½”ë“œ

```typescript
export const POST = async (req: Request) => {
  const url = new URL(await req.text());
  const lookupResult = await lookupAsync(url.hostname);
  const address = lookupResult.address;

  if (isPrivate(address)) {
    return NextResponse.json({ error: 'Not support internal host proxy' }, { status: 400 });
  }

  const res = await fetch(url.toString()); // redirect: follow (ê¸°ë³¸ê°’)
  return new Response(res.body, { headers: res.headers });
};
```

**ë¬¸ì œ ìš”ì•½:**

- `isPrivate()`ëŠ” "ìµœì¢… ìš”ì²­ ëª©ì ì§€"ê°€ ì•„ë‹ˆë¼ ì´ˆê¸° ìš”ì²­ í˜¸ìŠ¤íŠ¸ì˜ IPë§Œ ê²€ì‚¬í•¨
- ì´í›„ ë¦¬ë‹¤ì´ë ‰ì…˜ì´ ë‚´ë¶€ë§ìœ¼ë¡œ ì´ì–´ì§€ë©´ ë‚´ë¶€ë§ SSRF ì„±ê³µ

---

# ê³µê²© ì‹œë‚˜ë¦¬ì˜¤

**Step 1. ê³µê²©ì â†’ Lobe Chat ì„œë²„ íƒìƒ‰**

ê³µê²©ìê°€ Lobe Chat ì„œë²„ë¥¼ íƒìƒ‰

**Step 2. SSRF ì·¨ì•½ì  ì•…ìš©í•˜ì—¬ ë‚´ë¶€ë§ ì„œë¹„ìŠ¤ ì ‘ê·¼**

ì™¸ë¶€ ì£¼ì†Œë¥¼ í†µí•œ ë¦¬ë‹¤ì´ë ‰ì…˜ìœ¼ë¡œ ë‚´ë¶€ë§ ì ‘ê·¼

**Step 3. AWS EC2 ë©”íƒ€ë°ì´í„°(169.254.169.254) ì ‘ê·¼ â†’ IAM Role Credential íƒˆì·¨**

AWS EC2 ì¸ìŠ¤í„´ìŠ¤ëŠ” Metadata v1 ê¸°ì¤€ ë‹¤ìŒ ê²½ë¡œì—ì„œ IAM Roleì„ ë…¸ì¶œ:

```
http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

Roleëª…, AccessKeyId, SecretAccessKey, Token ê·¸ëŒ€ë¡œ íƒˆì·¨ ê°€ëŠ¥

**Step 4. íƒˆì·¨í•œ ìê²©ì¦ëª…ìœ¼ë¡œ EC2 ì›ê²© ì œì–´**

AWS CLIë¡œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì œì–´ ê°€ëŠ¥:

```bash
aws ec2 describe-instances --region ap-northeast-2 --profile stolen
```

**Step 5. ì¸ìŠ¤í„´ìŠ¤ì— ì•…ì„± ì½”ë“œ ì„¤ì¹˜ í›„ ë¯¼ê° ì •ë³´ ìœ ì¶œ**

ê³µê²©ìê°€ ì§ì ‘ ì›ê²© ëª…ë ¹ ì‹¤í–‰ê¹Œì§€ ìˆ˜í–‰ ê°€ëŠ¥

---

# ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±

| ì—­í•    | êµ¬ì„±                              | IP              |
| ------ | --------------------------------- | --------------- |
| í”¼í•´ì | Lobe Chat 1.19.12 (Docker)        | 192.168.102.74  |
| ê³µê²©ì | Kali Linux                        | 192.168.216.131 |

## ì‚¬ì „ ì¤€ë¹„ì‚¬í•­

- Lobe Chat ì·¨ì•½ ë²„ì „ ì„¤ì¹˜
- ê¸°ë³¸ì ì¸ HTTP ìš”ì²­ ì§€ì‹ (curl ë˜ëŠ” Burp Suite)
- SSRF ê³µê²© ê¸°ë²• ì´í•´
- AWS Metadata êµ¬ì¡° ì´í•´

---

# ì·¨ì•½ì  ìƒì„¸ ë¶„ì„

## 1) ì‚¬ìš©ì ì„¤ì • í”ŒëŸ¬ê·¸ì¸(Custom Plugin) ê¸°ëŠ¥

í”ŒëŸ¬ê·¸ì¸ì„ ë¶ˆëŸ¬ì˜¬ ë•Œ Manifest URLì„ ì…ë ¥í•˜ë©´ í•´ë‹¹ URLì„ `/api/proxy`ê°€ ëŒ€ì‹  ìš”ì²­í•´ì¤ë‹ˆë‹¤.

Manifest JSON ì˜ˆì‹œ:

```json
{
  "api": [
    {
      "url": "http://localhost:3400/api/clothes",
      "name": "recommendClothes",
      "parameters": { ... }
    }
  ],
  "gateway": "http://localhost:3400/api/gateway",
  "identifier": "chat-plugin-template",
  "ui": { "url": "http://localhost:3400", "height": 200 },
  "version": "1"
}
```

â¡ ì‚¬ìš©ì ì…ë ¥ URLì´ ê·¸ëŒ€ë¡œ í”„ë¡ì‹œ ìš”ì²­ì— ì‚¬ìš©ë¨.

## 2) ë‚´ë¶€ë§ í•„í„°ë§ ìš°íšŒ í¬ì¸íŠ¸

`isPrivate()`ëŠ” GitHub indutny/node-ip ê¸°ë°˜ìœ¼ë¡œ ì‚¬ì„¤ IP ë²”ìœ„ë§Œ ì •ê·œì‹ìœ¼ë¡œ ê²€ì‚¬í•©ë‹ˆë‹¤.

ë„ë©”ì¸ ê¸°ë°˜ ë¦¬ë‹¤ì´ë ‰íŠ¸ëŠ” ê²€ì‚¬ ë¶ˆê°€í•©ë‹ˆë‹¤.

ì¦‰,

```
http://attacker.com â†’ (302 redirect) â†’ http://192.168.0.10/llm
```

ì´ë©´ ë‚´ë¶€ë§ ì‘ë‹µì´ ê·¸ëŒ€ë¡œ ê³µê²©ì ë¸Œë¼ìš°ì €ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.

## ğŸš¨ SSRFë¥¼ ì´ìš©í•œ ì‹¤ì œ ê³µê²© ì˜ˆì‹œ

### 1) ë‚´ë¶€ LLM(Ollama) ì •ë³´ íƒˆì·¨

ì˜ˆì‹œ ê³µê²©:

```http
GET http://192.168.102.231:16728/api/tags
GET http://192.168.102.231:16728/api/ps
```

ëª¨ë¸ ëª©ë¡, ë©”ëª¨ë¦¬ ìƒ ëª¨ë¸ê¹Œì§€ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### 2) AWS IAM Role Credential íƒˆì·¨

AWS EC2 ì¸ìŠ¤í„´ìŠ¤ëŠ” Metadata v1 ê¸°ì¤€ ë‹¤ìŒ ê²½ë¡œì—ì„œ IAM Roleì„ ë…¸ì¶œí•©ë‹ˆë‹¤:

```
http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

Roleëª…, AccessKeyId, SecretAccessKey, Token ê·¸ëŒ€ë¡œ íƒˆì·¨ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì´í›„ ë‹¤ìŒê³¼ ê°™ì€ AWS CLIë¡œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì œì–´ ê°€ëŠ¥:

```bash
aws ec2 describe-instances --region ap-northeast-2 --profile stolen
```

ë˜ëŠ” ê³µê²©ìê°€ ì§ì ‘ ì›ê²© ëª…ë ¹ ì‹¤í–‰ê¹Œì§€ ìˆ˜í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.

## ğŸ’£ PoC ì‹¤í–‰ ì˜ˆì‹œ

```bash
python3 CVE-2024-47066.py -v http://192.168.102.74 -i http://www.internal-service:4000
```

â†’ ë‚´ë¶€ë§ì—ë§Œ ì¡´ì¬í•˜ëŠ” `http://www.internal-service:4000` ì‘ë‹µì„ ì„±ê³µì ìœ¼ë¡œ SSRFë¡œ íšë“

---

# íŒ¨ì¹˜ ì •ë³´

## ì•ˆì „í•œ ë²„ì „

- **Lobe Chat 1.19.13 ì´ìƒ**

## íŒ¨ì¹˜ ë‚´ìš©

### 1) ê²½ë¡œ ë³€ê²½

`/app/api/proxy/route.ts` â†’ `/app/webapi/proxy/route.ts`ë¡œ ë³€ê²½

### 2) request-filtering-agent ëª¨ë“ˆ ì‚¬ìš©

`request-filtering-agent` ëª¨ë“ˆì„ ì‚¬ìš©í•˜ì—¬ URL ì „ì²´ì— ëŒ€í•œ ì•ˆì „ì„± ê²€ì¦ ìˆ˜í–‰

DNS â†’ ë¦¬ë‹¤ì´ë ‰ì…˜ â†’ IP ê¸°ë°˜ í•„í„°ë§ì„ ëª¨ë‘ í†µí•© ê²€ì¦

ë‚´ë¶€ë§ ì ‘ê·¼ ì‹œ 400 ë°˜í™˜

### íŒ¨ì¹˜ ì½”ë“œ

```typescript
export const POST = async (req: Request) => {
  const url = await req.text();
  try {
    const res = await fetch(url, { agent: ssrfAgent(url) });
    return new Response(await res.arrayBuffer(), {
      headers: { ...res.headers },
    });
  } catch (err) {
    return NextResponse.json(
      { error: 'Not support internal host proxy' },
      { status: 400 }
    );
  }
};
```

## ì¦‰ì‹œ ì—…ë°ì´íŠ¸

Lobe Chat 1.19.12 ì´í•˜ëŠ” ì¦‰ì‹œ 1.19.13 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤.

---

# í•™ìŠµ í¬ì¸íŠ¸ (CVE í•™ìŠµììš© ìš”ì•½)

## ğŸ”¹ ë‚´ë¶€ë§ í•„í„°ë§ì€ "ì´ˆê¸° ìš”ì²­ IP ê¸°ë°˜"ì´ë©´ ìš°íšŒ ê°€ëŠ¥

ë¦¬ë‹¤ì´ë ‰íŠ¸ ê¸°ë°˜ SSRFëŠ” ë§¤ìš° í”í•œ ì·¨ì•½ì ì…ë‹ˆë‹¤.

## ğŸ”¹ LLM í”„ë¡ íŠ¸ì—”ë“œ í™˜ê²½ì€ ë‹¤ìˆ˜ì˜ ì™¸ë¶€ ì—°ê²° ê¸°ëŠ¥ í¬í•¨

í”ŒëŸ¬ê·¸ì¸Â·Proxy ê¸°ëŠ¥ í¬í•¨ ì‹œ SSRF ìœ„í—˜ ì¦ê°€.

## ğŸ”¹ Cloud í™˜ê²½ì€ SSRFê°€ ì¹˜ëª…ì 

AWS Metadata â†’ IAM Role íƒˆì·¨ â†’ RCEë¡œ ì´ì–´ì§‘ë‹ˆë‹¤.

## ğŸ”¹ SSRFëŠ” ë‹¨ì¼ ì·¨ì•½ì ì´ì§€ë§Œ ì—°ê³„ ê³µê²©ë ¥ì´ ê°•í•¨

ë‚´ë¶€ ì„œë¹„ìŠ¤ ì •ë³´ ìˆ˜ì§‘ â†’ Credential íƒˆì·¨.

---

# ì°¸ê³  ìë£Œ

- [PoC Repository](https://github.com/EQSTLab/CVE-2024-47066)

- [Patch Commit](https://github.com/lobehub/lobe-chat/tree/v1.19.13)

- [GitHub Advisory](https://github.com/advisories/GHSA-mxhq-xw3g-rphc)

- [Ollama API Docs](https://github.com/ollama/ollama/blob/main/docs/api.md)

