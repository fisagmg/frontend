"use client"

import { useState } from "react"
import { useRouter } from "next/navigation"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import { SeverityBadge } from "@/components/severity-badge"
import { ConfirmDialog } from "@/components/confirm-dialog"
import { useAuth } from "@/lib/auth-context"
import type { CVEItem } from "@/lib/mock-data"
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip"
import { CheckCircle } from "lucide-react"
import { cn } from "@/lib/utils"

interface CVECardProps {
  cve: CVEItem
  showLabButton?: boolean
  isCompleted?: boolean
}

export function CVECard({ cve, showLabButton = true, isCompleted = false }: CVECardProps) {
  const router = useRouter()
  const { isAuthed } = useAuth()
  const [showLabDialog, setShowLabDialog] = useState(false)

  const handleLabClick = () => {
    if (!isAuthed) {
      router.push(`/login?redirect=/learn`)
      return
    }
    setShowLabDialog(true)
  }

  const handleLabConfirm = () => {
    setShowLabDialog(false)
    router.push(`/lab/${cve.id}/start`)
  }

  return (
    <>
      <Card className={cn(
        "group bg-white hover:shadow-lg transition-all duration-300 border-none shadow-sm ring-1 ring-zinc-900/5 h-fit relative",
        isCompleted && "ring-2 ring-emerald-400 hover:ring-emerald-500"
      )}>
        {isCompleted && (
          <div className="absolute -top-2 -right-2 z-10 bg-white rounded-full">
            <CheckCircle className="h-6 w-6 text-emerald-500 fill-white" />
          </div>
        )}
        <CardHeader className="pb-3">
          <div className="flex items-start justify-between gap-2">
            <CardTitle className="text-lg text-zinc-900">{cve.id}</CardTitle>
            <SeverityBadge score={cve.cvssScore} level={cve.severity} />
          </div>
        </CardHeader>
        <CardContent className="space-y-3">
          {/* Tags - Always visible */}
          <div className="flex flex-wrap gap-2">
            {cve.tags.slice(0, 3).map((tag) => (
              <Badge key={tag} variant="secondary" className="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 border-none">
                {tag}
              </Badge>
            ))}
          </div>

          {/* Expandable Content: Summary & Buttons */}
          <div className="grid grid-rows-[0fr] opacity-0 group-hover:grid-rows-[1fr] group-hover:opacity-100 transition-all duration-300">
            <div className="overflow-hidden">
              <div className="space-y-4 pt-2">
                <p className="text-sm text-zinc-600 line-clamp-2">{cve.summary}</p>
                <div className="flex gap-2">
                  <Button onClick={() => router.push(`/learn/${cve.id}`)} variant="ghost" className="flex-1 bg-zinc-100 text-zinc-700 hover:bg-zinc-200 hover:text-zinc-900">
                    자세히 보기
                  </Button>
                  {showLabButton && (
                    <TooltipProvider>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <div className="flex-1">
                            <Button 
                              onClick={handleLabClick} 
                              disabled={!isAuthed} 
                              className={cn(
                                "w-full shadow-sm",
                                isCompleted 
                                  ? "bg-emerald-500 hover:bg-emerald-600 text-white" 
                                  : "bg-zinc-900 text-white hover:bg-zinc-800"
                              )}
                            >
                              {isCompleted ? "다시 학습하기" : "실습하기"}
                            </Button>
                          </div>
                        </TooltipTrigger>
                        {!isAuthed && (
                          <TooltipContent>
                            <p>로그인이 필요합니다</p>
                          </TooltipContent>
                        )}
                      </Tooltip>
                    </TooltipProvider>
                  )}
                </div>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      <ConfirmDialog
        open={showLabDialog}
        onOpenChange={setShowLabDialog}
        title={isCompleted ? "실습을 다시 시작할까요?" : "해당 CVE로 실습을 시작할까요?"}
        description={isCompleted ? "이전 실습 기록은 유지되며, 새로운 환경에서 실습이 시작됩니다." : "실습 환경으로 이동하여 실습을 시작합니다."}
        onConfirm={handleLabConfirm}
      />
    </>
  )
}
